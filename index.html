<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAVEL - Sistema Oficial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* TEMA LARANJA INSTITUCIONAL */
        :root { 
            --primary: #E65100; 
            --secondary: #1565C0; 
            --bg-light: #f4f4f9; 
            --text: #333; 
            --red: #d32f2f; 
            --purple: #8e24aa; 
            --gray: #9e9e9e; 
            --success: #2E7D32; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-light); color: var(--text); margin:0; padding:10px; }
        
        .screen { display: none; max-width: 950px; margin: 0 auto; }
        .screen.active { display: block; }

        /* Login */
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; margin-top: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin-left: auto; margin-right: auto; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        .logos-login { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; align-items: center; }
        .logos-login img { max-height: 120px; max-width: 180px; object-fit: contain; }

        /* Header */
        .app-header { background: var(--primary); color: white; padding: 15px; border-radius: 0 0 12px 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-logout { background: rgba(0,0,0,0.2); border: none; color: white; padding: 5px 12px; border-radius: 4px; cursor: pointer; }

        /* ABAS */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e0e0e0; border-radius: 8px; font-weight: bold; cursor: pointer; color: #555; white-space: nowrap; min-width: 100px; }
        .tab-btn.active { background: var(--secondary); color: white; }

        /* Componentes */
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* Alunos e Tabelas */
        .aluno-row { background: white; padding: 10px; margin-bottom: 5px; border-left: 5px solid #ccc; border-radius: 6px; transition: 0.3s; }
        .aluno-row.avaliado { border-left-color: var(--primary); background: #FFF3E0; } 
        .aluno-row.ausente { border-left-color: var(--red); background: #ffebee; }
        .aluno-row.transferido { border-left-color: var(--gray); background: #f0f0f0; opacity: 0.7; }
        .aluno-row.transferido strong { text-decoration: line-through; color: #777; }
        
        .controls { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
        select { padding: 8px; border-radius: 4px; flex: 1; border: 1px solid #ccc; }
        .laudo-chk { background: #eee; padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        
        /* Tabela Comparativa */
        .comp-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .comp-table th { background: #f0f0f0; padding: 8px; text-align: left; color: #555; }
        .comp-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .badge-up { background: #e8f5e9; color: var(--success); }
        .badge-down { background: #ffebee; color: var(--red); }
        .badge-same { background: #f5f5f5; color: #777; }
        
        /* Dashboard KPI */
        .dash-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 15px; }
        .kpi-card { background: white; padding: 10px; text-align: center; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-num { font-size: 1.4rem; font-weight: bold; color: var(--secondary); }
        .kpi-label { font-size: 0.75rem; color: #666; margin-top: 2px; }
        
        .adm-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .adm-table th, .adm-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        
        /* Bot√µes de A√ß√£o na Tabela */
        .btn-table { padding: 6px 8px; border: none; background: transparent; border-radius: 4px; cursor: pointer; font-size: 1.1rem; margin-right: 5px; transition: background 0.2s; }
        .btn-table:hover { background: #e0e0e0; }

        /* Filtros */
        .filter-container { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
        .chk-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .chk-label { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; background: #eee; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .chk-label:has(input:checked) { background: #FFE0B2; border: 1px solid var(--primary); } 
        .date-select-group { display: flex; gap: 3px; align-items: center; }
        .date-select-group select { padding: 6px; font-size: 0.85rem; min-width: 60px; }

        /* Utilit√°rios */
        .hidden { display: none !important; }
        .tag-laudo { color: var(--red); font-weight: bold; font-size: 0.75rem; display: none; }
        .aluno-row.com-laudo .tag-laudo { display: inline; }
        .action-bar { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-tool { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; }
        .modal-content { background: white; width: 100%; max-width: 700px; border-radius: 10px; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; border-radius: 10px 10px 0 0; }
        .modal-header h3 { margin: 0; font-size: 1.1rem; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; background: #f9f9f9; border-radius: 0 0 10px 10px; }
        .close-btn { background: transparent; border: none; font-size: 1.2rem; cursor: pointer; color: white; font-weight: bold; }
        .modal-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .modal-table th, .modal-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        .modal-table tr.transferido { background: #f0f0f0; opacity: 0.7; }
        .modal-table tr.transferido td:first-child { text-decoration: line-through; color: #777; }
        
        @media print { .no-print { display: none !important; } }
        @media (max-width: 700px) { 
            .dash-grid { grid-template-columns: 1fr 1fr; } 
            .tabs { flex-wrap: wrap; } 
            .filter-row { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="login-box">
            <div class="logos-login">
                <img src="logo-prefeitura.png" alt="Prefeitura" onerror="this.style.display='none'">
                <img src="logo-secretaria.png" alt="Secretaria" onerror="this.style.display='none'">
            </div>
            <p style="margin-top: 5px; font-weight: bold; font-size: 1.1rem; color: #555;">Gest√£o & Evolu√ß√£o de Leitura</p>
            <input type="text" id="email" placeholder="E-mail">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn-main" onclick="login()">ENTRAR</button>
            <p id="msg-login" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="screen-app" class="screen">
        <div class="app-header">
            <span id="header-user">Professor</span>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>

        <div class="tabs no-print">
            <button class="tab-btn active" onclick="mudarAbaProf('nova')" id="tab-nova">üìù Nova</button>
            <button class="tab-btn" onclick="mudarAbaProf('hist')" id="tab-hist">üìä Meu Painel</button>
            <button class="tab-btn" onclick="mudarAbaProf('evo')" id="tab-evo">üìà Evolu√ß√£o</button>
        </div>

        <div id="view-nova">
            <div id="area-config" class="card">
                <h3>Configurar Avalia√ß√£o</h3>
                <label>Data:</label>
                <div class="date-select-group" style="margin-bottom:10px;">
                    <select id="sel-dia"></select>
                    <select id="sel-mes"><option value="01">Jan</option><option value="02">Fev</option><option value="03">Mar</option><option value="04">Abr</option><option value="05">Mai</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Ago</option><option value="09">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option></select>
                    <select id="sel-ano"><option value="2026">2026</option><option value="2025">2025</option></select>
                </div>
                <label>Escola:</label>
                <select id="sel-escola" style="width:100%; margin-bottom:10px;" onchange="verificarHistoricoTurma()"></select>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;"><label>S√©rie:</label><select id="sel-serie" style="width:100%;" onchange="verificarHistoricoTurma()"></select></div>
                    <div style="flex:1;">
                        <label>Turma:</label>
                        <select id="sel-turma" style="width:100%;" onchange="verificarHistoricoTurma()">
                            <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
                            <option>F</option><option>G</option><option>H</option><option>I</option><option>J</option><option>K</option>
                            <option>Unica</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <label style="margin:0;">Alunos:</label>
                    <small id="msg-importacao" style="font-weight:bold; display:none;"></small>
                </div>
                <textarea id="lista-alunos" style="width:100%; height:100px; border-radius:8px; border:1px solid #ccc;"></textarea>
                <button class="btn-main" onclick="iniciarAvaliacao()">COME√áAR</button>
            </div>

            <div id="area-avaliacao" class="hidden">
                <div class="action-bar no-print">
                    <button class="btn-tool" style="background:#1565C0;" onclick="salvarNaNuvem()">‚òÅÔ∏è SALVAR NO BANCO</button>
                    <button class="btn-tool" style="background:#D32F2F;" onclick="gerarPDF()">üìÑ GERAR PDF</button>
                    <button class="btn-tool" style="background:var(--success);" onclick="compartilharZap()">üì± COMPARTILHAR ZAP</button>
                </div>
                <div class="card" style="border-left:5px solid var(--secondary);">
                    <h3 id="resumo-titulo" style="margin:0;">Escola</h3>
                    <p style="margin:5px 0; color:#666;"><span id="resumo-data">--</span> | <span id="resumo-sub">Turma</span></p>
                    <div id="stats-rapido" style="font-weight:bold;">0 Avaliados</div>
                </div>
                <div id="container-alunos"></div>
                <div class="card no-print" style="background:#eee; text-align:center;">
                    <input type="text" id="extra-nome" placeholder="Aluno extra..." style="width:70%;">
                    <button onclick="addExtra()" style="width:20%; padding:10px;">+</button>
                </div>
                <button class="btn-main no-print" style="background:#666;" onclick="voltarConfig()">VOLTAR E DESCARTAR</button>
            </div>
        </div>

        <div id="view-hist" class="hidden">
            <div class="filter-container">
                <div style="margin-bottom:5px; font-weight:bold; color:#555; font-size:0.9rem;">Filtrar meus dados:</div>
                <div class="filter-row">
                    <select id="prof-filtro-escola" onchange="aplicarFiltrosProf()"><option value="TODAS">Todas as Escolas</option></select>
                    <select id="prof-filtro-serie" onchange="aplicarFiltrosProf()">
                        <option value="TODAS">Todas as S√©ries</option>
                        <option value="1¬∫ Ano">1¬∫ Ano</option><option value="2¬∫ Ano">2¬∫ Ano</option><option value="3¬∫ Ano">3¬∫ Ano</option><option value="4¬∫ Ano">4¬∫ Ano</option><option value="5¬∫ Ano">5¬∫ Ano</option><option value="Multisseriada">Multisseriada</option>
                    </select>
                    <select id="prof-filtro-turma" onchange="aplicarFiltrosProf()">
                        <option value="TODAS">Todas as Turmas</option>
                        <option value="A">Turma A</option><option value="B">Turma B</option><option value="C">Turma C</option><option value="D">Turma D</option><option value="E">Turma E</option><option value="F">Turma F</option><option value="G">Turma G</option><option value="H">Turma H</option><option value="I">Turma I</option><option value="J">Turma J</option><option value="K">Turma K</option><option value="Unica">√önica</option>
                    </select>
                </div>
                <div class="filter-row" style="background:#eee; padding:5px; border-radius:6px;">
                    <span style="font-size:0.8rem; font-weight:bold;">Filtrar Data:</span>
                    <div class="date-select-group">
                        <select id="prof-mes-filtro" onchange="aplicarFiltrosProf()">
                            <option value="TODOS">M√™s (Todos)</option>
                            <option value="01">Janeiro</option><option value="02">Fevereiro</option><option value="03">Mar√ßo</option><option value="04">Abril</option><option value="05">Maio</option><option value="06">Junho</option><option value="07">Julho</option><option value="08">Agosto</option><option value="09">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                        </select>
                        <select id="prof-ano-filtro" onchange="aplicarFiltrosProf()">
                            <option value="TODOS">Todos os Anos</option>
                            <option value="2026">2026</option><option value="2025">2025</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="dash-grid">
                <div class="kpi-card"><div class="kpi-num" id="prof-total">0</div><div class="kpi-label">Avaliados</div></div>
                <div class="kpi-card"><div class="kpi-num" id="prof-fluente" style="color:var(--success);">0%</div><div class="kpi-label">Fluentes</div></div>
                <div class="kpi-card"><div class="kpi-num" id="prof-critico" style="color:var(--red);">0%</div><div class="kpi-label">N√≠veis Iniciais</div></div>
                <div class="kpi-card"><div class="kpi-num" id="prof-ausente" style="color:var(--orange);">0%</div><div class="kpi-label">Aus√™ncia</div></div>
                <div class="kpi-card"><div class="kpi-num" id="prof-laudo" style="color:var(--purple);">0</div><div class="kpi-label">Com Laudo</div></div>
            </div>

            <div class="card">
                <h3>Minhas Turmas</h3>
                <button onclick="carregarHistoricoProf()" style="float:right; font-size:0.7rem;">Atualizar</button>
                <table class="adm-table">
                    <thead><tr><th>Turma</th><th>Data</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="tabela-prof"></tbody>
                </table>
            </div>
        </div>

        <div id="view-evo" class="hidden">
            <div class="card">
                <h3>üîç Comparar Turma</h3>
                <label>Selecione a Turma:</label>
                <select id="filtro-evo-turma" style="width:100%; margin-bottom:10px;"><option value="">Carregando...</option></select>
                <button class="btn-main" onclick="gerarRelatorioEvolucao()" style="padding:10px;">GERAR COMPARATIVO</button>
            </div>
            <div id="resultado-evo" class="hidden">
                <div class="card">
                    <h4>Resultado Comparativo</h4>
                    <p id="evo-info" style="font-size:0.9rem; color:#666;"></p>
                    <table class="comp-table">
                        <thead><tr><th>Aluno</th><th>Antes</th><th>Agora</th><th>Evolu√ß√£o</th></tr></thead>
                        <tbody id="tabela-evo"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div class="app-header" style="background:#333;">
            <span>Painel Gestor</span>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>

        <div class="filter-container">
            <div style="margin-bottom:10px; font-weight:bold; color:#555;">Filtros:</div>
            <div class="filter-row">
                <select id="filtro-escola" onchange="aplicarFiltros()" style="max-width:200px;"><option value="TODAS">Todas as Escolas</option></select>
                <div class="date-select-group">
                    <select id="adm-dia-ini"><option value="">Dia</option></select>
                    <select id="adm-mes-ini"><option value="01">Jan</option><option value="02">Fev</option><option value="03">Mar</option><option value="04">Abr</option><option value="05">Mai</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Ago</option><option value="09">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option></select>
                    <select id="adm-ano-ini"><option value="2026">2026</option></select>
                </div>
            </div>
            <div class="filter-row">
                <div class="chk-group" id="chk-series">
                    <label class="chk-label"><input type="checkbox" value="1¬∫ Ano" checked onchange="aplicarFiltros()"> 1¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="2¬∫ Ano" checked onchange="aplicarFiltros()"> 2¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="3¬∫ Ano" checked onchange="aplicarFiltros()"> 3¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="4¬∫ Ano" checked onchange="aplicarFiltros()"> 4¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="5¬∫ Ano" checked onchange="aplicarFiltros()"> 5¬∫</label>
                </div>
                <button onclick="carregarAdmin()" style="background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-left:auto;">üîÑ Atualizar</button>
            </div>
        </div>

        <div class="dash-grid">
            <div class="kpi-card"><div class="kpi-num" id="adm-total">0</div><div class="kpi-label">Avaliados</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-fluente" style="color:var(--success);">0%</div><div class="kpi-label">Fluentes</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-critico" style="color:var(--red);">0%</div><div class="kpi-label">N√≠veis Iniciais</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-ausente" style="color:var(--orange);">0%</div><div class="kpi-label">Aus√™ncia</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-laudo" style="color:var(--purple);">0</div><div class="kpi-label">Com Laudo</div></div>
        </div>

        <div class="card">
            <h3>Registros</h3>
            <table class="adm-table">
                <thead><tr><th>Escola</th><th>Turma</th><th>Data</th><th>Prof.</th><th>Flu√™ncia</th><th>A√ß√µes</th></tr></thead>
                <tbody id="tabela-envios"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-detalhes" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-titulo">Detalhes da Turma</h3>
                <button class="close-btn" onclick="fecharModal()">X</button>
            </div>
            <div class="modal-body" id="modal-body">
                </div>
            <div class="modal-footer hidden" id="modal-footer">
                <button class="btn-main" onclick="salvarEdicaoModal()" style="margin:0;">üíæ SALVAR ALTERA√á√ïES</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, push, get, remove, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYV-OOz55TvJ7cLPfJkDP7idGL25MXxis",
            authDomain: "leituramineiros.firebaseapp.com",
            databaseURL: "https://leituramineiros-default-rtdb.firebaseio.com",
            projectId: "leituramineiros",
            storageBucket: "leituramineiros.firebasestorage.app",
            messagingSenderId: "221434879480",
            appId: "1:221434879480:web:1ca32bfc8ad743b5974a0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const PERFIS = {
            'jane@siavel.com': { nome: 'Jane', escolas: ['Paniago', 'Otal√©cio', 'Maria Eduarda', 'Salviano', 'Dom Bosco', 'Santo Ant√¥nio', 'Elias Carrijo', 'Tonico', 'Professor Juarez'], series: ['4¬∫ Ano', '5¬∫ Ano'], modo: 'padrao' },
            'wellita@siavel.com': { nome: 'Wellita', escolas: ['Paniago', 'Otal√©cio', 'Maria Eduarda', 'Salviano', 'Dom Bosco', 'Santo Ant√¥nio', 'Elias Carrijo', 'Tonico', 'Professor Juarez'], series: ['3¬∫ Ano'], modo: 'padrao' },
            'marcia@siavel.com': { nome: 'Marcia', escolas: ['Reverendo Eud√≥xio', 'Comecinho de Vida', 'Castelo Branco', 'Maria Eduarda', 'Padre Maximino', 'Dom Bosco', 'Professor Salviano Neves Amorim', 'Santo Ant√¥nio', 'Professor Juarez', 'Tonico Corredeira', 'Elias Carrijo de Souza', 'Paniago'], series: ['1¬∫ Ano', '2¬∫ Ano'], modo: 'padrao' },
            'welma@siavel.com': { nome: 'Welma', escolas: ['ESCOLA AM√âRICO CAETANO', 'ESCOLA FARROUPILHA', 'ESCOLA FARROUPILHA EXTENS√ÉO', 'ESCOLA ANTONIO ALVES', 'ESCOLA GUSTAVO ALVES', 'ESCOLA ANTONIO MESSIAS', 'ESCOLA CAIND√ÉO', 'ESCOLA SALTO', 'ESCOLA MORRO DOIS IRM√ÉOS', 'ESCOLA PINGUELA'], series: ['Multisseriada'], modo: 'rural' },
            'adm@siavel.com': { nome: 'Admin', modo: 'admin' }
        };

        const NIVEIS = ["N√≠vel 1", "N√≠vel 2", "N√≠vel 3", "N√≠vel 4", "Iniciante", "Fluente"];
        const PESO_NIVEL = { "Ausente": 0, "N√≠vel 1": 1, "N√≠vel 2": 2, "N√≠vel 3": 3, "N√≠vel 4": 4, "Iniciante": 5, "Fluente": 6 };
        
        let usuarioAtual = null;
        let dadosTurma = {};
        let meusEnviosCache = [];
        let todosDadosAdm = []; 
        let turmaAtualEdicao = null; 

        (function initDias() { 
            const s = document.getElementById('sel-dia'); 
            const sAdm = document.getElementById('adm-dia-ini');
            for(let i=1; i<=31; i++){ 
                let o = document.createElement('option'); o.value = i < 10 ? "0"+i : i; o.innerText = i; s.appendChild(o.cloneNode(true)); sAdm.appendChild(o);
            } 
        })();

        window.login = () => {
            const e = document.getElementById('email').value;
            const s = document.getElementById('senha').value;
            signInWithEmailAndPassword(auth, e, s).catch(err => document.getElementById('msg-login').innerText = "Erro no Login.");
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (user) {
                const email = user.email;
                if (PERFIS[email]) {
                    usuarioAtual = { ...PERFIS[email], email: email };
                    if (usuarioAtual.modo === 'admin') {
                        document.getElementById('screen-admin').classList.add('active');
                        carregarAdmin();
                    } else {
                        document.getElementById('screen-app').classList.add('active');
                        configurarInterfaceProfessor();
                        carregarHistoricoProf();
                    }
                } else { alert("Usu√°rio n√£o configurado."); signOut(auth); }
            } else { document.getElementById('screen-login').classList.add('active'); }
        });

        window.mudarAbaProf = (aba) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            ['view-nova','view-hist','view-evo'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if(aba === 'nova') { document.getElementById('tab-nova').classList.add('active'); document.getElementById('view-nova').classList.remove('hidden'); }
            else if(aba === 'hist') { document.getElementById('tab-hist').classList.add('active'); document.getElementById('view-hist').classList.remove('hidden'); carregarHistoricoProf(); }
            else if(aba === 'evo') { document.getElementById('tab-evo').classList.add('active'); document.getElementById('view-evo').classList.remove('hidden'); prepararComparativo(); }
        };

        function configurarInterfaceProfessor() {
            document.getElementById('header-user').innerText = `Ol√°, ${usuarioAtual.nome}`;
            const se = document.getElementById('sel-escola'); se.innerHTML = '<option value="">Selecione...</option>';
            usuarioAtual.escolas.forEach(esc => se.innerHTML += `<option>${esc}</option>`);
            const ss = document.getElementById('sel-serie'); ss.innerHTML = '';
            usuarioAtual.series.forEach(ser => ss.innerHTML += `<option>${ser}</option>`);
            mudarAbaProf('nova');
        }

        // ==========================================
        // NOVO SISTEMA DE IMPORTA√á√ÉO AUTOM√ÅTICA
        // ==========================================
        window.verificarHistoricoTurma = async () => {
            const esc = document.getElementById('sel-escola').value;
            const ser = document.getElementById('sel-serie').value;
            const tur = document.getElementById('sel-turma').value;
            const msg = document.getElementById('msg-importacao');
            const txtLista = document.getElementById('lista-alunos');

            msg.style.display = 'none';
            
            // Regra de Ouro: Mudou a turma? Limpa a lista atual para n√£o misturar.
            txtLista.value = "";
            dadosTurma = {}; 

            if(esc && ser && tur) {
                msg.innerText = "‚è≥ Buscando alunos...";
                msg.style.display = 'block';
                msg.style.color = "#f57c00";

                try {
                    const dbRef = ref(db, 'avaliacoes');
                    const snapshot = await get(dbRef);
                    
                    if (snapshot.exists()) {
                        const all = Object.values(snapshot.val());
                        const matches = all.filter(d => d.escola === esc && d.serie === ser && d.turma === tur);
                        
                        if (matches.length > 0) {
                            matches.sort((a, b) => new Date(b.data_envio || 0) - new Date(a.data_envio || 0));
                            const ultima = matches[0];
                            
                            if (ultima.detalhes && Array.isArray(ultima.detalhes)) {
                                const nomes = ultima.detalhes.map(a => a.nome).join('\n');
                                txtLista.value = nomes;
                                msg.innerText = `üìã Lista importada de ${ultima.data_avaliacao}`;
                                msg.style.color = "var(--primary)";
                            }
                        } else {
                            msg.innerText = "‚ú® Turma nova (Digite os nomes abaixo)";
                            msg.style.color = "#666";
                        }
                    } else {
                        msg.style.display = 'none';
                    }
                } catch (error) {
                    console.error("Erro ao buscar hist√≥rico: ", error);
                    msg.style.display = 'none';
                }
            }
        };

        window.iniciarAvaliacao = () => {
            const escola = document.getElementById('sel-escola').value;
            const lista = document.getElementById('lista-alunos').value.split('\n').filter(n=>n.trim()!=='');
            const d = document.getElementById('sel-dia').value;
            const m = document.getElementById('sel-mes').value;
            const a = document.getElementById('sel-ano').value;
            if(!d) return alert("Selecione o Dia!");
            if (!escola || lista.length === 0) return alert("Preencha dados!");

            dadosTurma.alunos = lista.map(nome => ({ nome, nivel: '', laudo: false, serieRural: '', transferido: false }));

            dadosTurma.escola = escola;
            dadosTurma.serie = document.getElementById('sel-serie').value;
            dadosTurma.turma = document.getElementById('sel-turma').value;
            dadosTurma.data = `${d}/${m}/${a}`;

            renderizarAvaliacao();
            document.getElementById('area-config').classList.add('hidden');
            document.getElementById('area-avaliacao').classList.remove('hidden');
        };

        function renderizarAvaliacao() {
            document.getElementById('resumo-titulo').innerText = dadosTurma.escola;
            document.getElementById('resumo-data').innerText = dadosTurma.data;
            document.getElementById('resumo-sub').innerText = `${dadosTurma.serie} - Turma ${dadosTurma.turma}`;
            const container = document.getElementById('container-alunos'); container.innerHTML = '';
            
            if(!dadosTurma.alunos) dadosTurma.alunos = [];

            dadosTurma.alunos.forEach((aluno, idx) => {
                const div = document.createElement('div'); div.className = 'aluno-row'; div.id = `row-${idx}`;
                let htmlSerie = '';
                if (usuarioAtual.modo === 'rural') {
                    htmlSerie = `<select class="sel-serie-rural" onchange="window.updateLocal(${idx}, this.value)" ${aluno.transferido?'disabled':''}><option value="">S√©rie...</option>${["1¬∫ Ano","2¬∫ Ano","3¬∫ Ano","4¬∫ Ano","5¬∫ Ano"].map(s=>`<option value="${s}" ${aluno.serieRural===s?'selected':''}>${s}</option>`).join('')}</select>`;
                }
                
                if(aluno.transferido) div.classList.add('transferido');

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;"><strong>${aluno.nome} <span class="tag-laudo">(LAUDO)</span></strong></div>
                    <div class="controls">
                        <label class="laudo-chk"><input type="checkbox" onchange="window.toggleLaudo(${idx})" ${aluno.laudo?'checked':''} ${aluno.transferido?'disabled':''}> Laudo</label>
                        <label class="laudo-chk" style="color:var(--red);"><input type="checkbox" onchange="window.toggleTransferido(${idx})" ${aluno.transferido?'checked':''}> Transf.</label>
                        ${htmlSerie}
                        <select onchange="window.updateNivel(${idx}, this.value)" ${aluno.transferido?'disabled':''}>
                            <option value="">Avaliar...</option><option value="Ausente">‚ö†Ô∏è Ausente</option>${NIVEIS.map(n=>`<option value="${n}" ${aluno.nivel===n?'selected':''}>${n}</option>`).join('')}
                        </select>
                    </div>`;
                container.appendChild(div);
                if(aluno.laudo) div.classList.add('com-laudo');
            });
            atualizarStats();
        }

        window.toggleLaudo = (idx) => { dadosTurma.alunos[idx].laudo = !dadosTurma.alunos[idx].laudo; document.getElementById(`row-${idx}`).classList.toggle('com-laudo'); };
        window.toggleTransferido = (idx) => { dadosTurma.alunos[idx].transferido = !dadosTurma.alunos[idx].transferido; if(dadosTurma.alunos[idx].transferido) { dadosTurma.alunos[idx].nivel = ""; } renderizarAvaliacao(); };
        window.updateNivel = (idx, val) => { dadosTurma.alunos[idx].nivel = val; const row = document.getElementById(`row-${idx}`); row.className = 'aluno-row ' + (dadosTurma.alunos[idx].laudo ? 'com-laudo' : ''); if (val === 'Ausente') row.classList.add('ausente'); else if (val) row.classList.add('avaliado'); atualizarStats(); };
        window.updateLocal = (idx, val) => { dadosTurma.alunos[idx].serieRural = val; };
        window.addExtra = () => { const nome = document.getElementById('extra-nome').value; if(nome) { dadosTurma.alunos.push({ nome, nivel: '', laudo: false, serieRural: '', transferido: false }); renderizarAvaliacao(); document.getElementById('extra-nome').value = ''; } };
        window.voltarConfig = () => { if(confirm("Voltar sem salvar?")) { document.getElementById('area-avaliacao').classList.add('hidden'); document.getElementById('area-config').classList.remove('hidden'); dadosTurma = {}; } };
        
        function atualizarStats() { 
            const ativos = dadosTurma.alunos.filter(a => !a.transferido);
            const aval = ativos.filter(a => a.nivel && a.nivel !== 'Ausente').length; 
            const aus = ativos.filter(a => a.nivel === 'Ausente').length; 
            document.getElementById('stats-rapido').innerText = `Status: ${aval} Avaliados | ${aus} Ausentes`; 
        }

        window.salvarNaNuvem = async () => {
            const btn = document.querySelector('button[onclick="salvarNaNuvem()"]'); btn.innerText = "‚è≥ Enviando...";
            const ativos = dadosTurma.alunos.filter(a => !a.transferido);
            const cont = {}; NIVEIS.forEach(n => cont[n] = 0); let aval = 0, aus = 0;
            ativos.forEach(a => { if (a.nivel === 'Ausente') aus++; else if (a.nivel) { aval++; cont[a.nivel]++; } });
            
            const pacote = { 
                escola: dadosTurma.escola, turma: dadosTurma.turma, serie: dadosTurma.serie, professor: usuarioAtual.nome, 
                data_avaliacao: dadosTurma.data, data_envio: new Date().toISOString(), 
                total_alunos: ativos.length, total_avaliados: aval, total_ausentes: aus, 
                resultados: cont, detalhes: dadosTurma.alunos 
            };
            try { await push(ref(db, 'avaliacoes'), pacote); alert("‚úÖ Sucesso!"); btn.innerText = "‚òÅÔ∏è SALVAR NO BANCO"; document.getElementById('lista-alunos').value = ""; document.getElementById('area-avaliacao').classList.add('hidden'); document.getElementById('area-config').classList.remove('hidden'); dadosTurma = {}; } catch (e) { console.error(e); alert("Erro: " + e.message); btn.innerText = "‚òÅÔ∏è Tentar Novamente"; }
        };

        window.gerarPDF = () => { const el = document.getElementById('area-avaliacao'); document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none'); html2pdf().from(el).save(`${dadosTurma.escola}.pdf`).then(() => { document.querySelectorAll('.no-print').forEach(e => e.style.display = ''); }); };
        window.compartilharZap = () => { let txt = `*${dadosTurma.escola}*\nData: ${dadosTurma.data}\nAv: ${dadosTurma.alunos.filter(a=>a.nivel&&a.nivel!='Ausente' && !a.transferido).length}\n\n`; dadosTurma.alunos.forEach(a => { if(!a.transferido && a.nivel) txt += `${a.nivel==='Ausente'?'‚ö†Ô∏è':'‚úÖ'} ${a.nome}: ${a.nivel}\n`; }); window.open("https://wa.me/?text=" + encodeURIComponent(txt)); };

        // ==========================================
        // L√ìGICA DO MODAL DE INSPE√á√ÉO E EDI√á√ÉO
        // ==========================================
        
        window.fecharModal = () => {
            document.getElementById('modal-detalhes').classList.add('hidden');
            turmaAtualEdicao = null;
        };

        window.renderizarTabelaModal = (isProf) => {
            const isRural = turmaAtualEdicao.serie === 'Multisseriada' || turmaAtualEdicao.professor === 'Welma';
            
            let profFiltroSerie = 'TODAS';
            let admChkSeries = [];
            if (isRural) {
                if (isProf) {
                    profFiltroSerie = document.getElementById('prof-filtro-serie').value;
                } else {
                    admChkSeries = Array.from(document.querySelectorAll('#chk-series input:checked')).map(c => c.value);
                }
            }

            let html = '<table class="modal-table"><thead><tr><th>Aluno</th>';
            if (isRural) html += '<th>S√©rie</th>';
            html += '<th>Laudo</th><th>Transf.</th><th>Avalia√ß√£o</th></tr></thead><tbody>';
            
            let exibiuAlunos = false;

            turmaAtualEdicao.detalhes.forEach((aluno, idx) => {
                if (isRural) {
                    if (isProf && profFiltroSerie !== "TODAS" && aluno.serieRural !== profFiltroSerie) return; 
                    if (!isProf && admChkSeries.length > 0 && !admChkSeries.includes(aluno.serieRural)) return; 
                }

                exibiuAlunos = true;

                if (isProf) {
                    let options = `<option value="">- Sem Nota -</option><option value="Ausente" ${aluno.nivel==='Ausente'?'selected':''}>Ausente</option>`;
                    NIVEIS.forEach(n => { options += `<option value="${n}" ${aluno.nivel===n?'selected':''}>${n}</option>`; });
                    
                    let ruralTd = '';
                    if (isRural) {
                        ruralTd = `<td><select onchange="turmaAtualEdicao.detalhes[${idx}].serieRural = this.value" ${aluno.transferido?'disabled':''} style="padding:4px; border-radius:4px; border:1px solid #ccc; max-width:85px;">
                            <option value="">S√©rie...</option>
                            ${["1¬∫ Ano","2¬∫ Ano","3¬∫ Ano","4¬∫ Ano","5¬∫ Ano"].map(s=>`<option value="${s}" ${aluno.serieRural===s?'selected':''}>${s}</option>`).join('')}
                        </select></td>`;
                    }

                    html += `<tr class="${aluno.transferido ? 'transferido' : ''}">
                        <td><strong>${aluno.nome}</strong></td>
                        ${ruralTd}
                        <td><input type="checkbox" onchange="turmaAtualEdicao.detalhes[${idx}].laudo = this.checked" ${aluno.laudo?'checked':''} ${aluno.transferido?'disabled':''}></td>
                        <td><input type="checkbox" onchange="turmaAtualEdicao.detalhes[${idx}].transferido = this.checked; if(this.checked){turmaAtualEdicao.detalhes[${idx}].nivel=''} renderizarTabelaModal(true)" ${aluno.transferido?'checked':''}></td>
                        <td><select onchange="turmaAtualEdicao.detalhes[${idx}].nivel = this.value" ${aluno.transferido?'disabled':''}>${options}</select></td>
                    </tr>`;
                } else {
                    let badgeTransf = aluno.transferido ? '<span style="color:var(--gray)">Sim</span>' : 'N√£o';
                    let badgeLaudo = aluno.laudo ? '<span style="color:var(--purple)">Sim</span>' : 'N√£o';
                    let stilo = aluno.transferido ? 'class="transferido"' : '';
                    let ruralTd = isRural ? `<td>${aluno.serieRural || '-'}</td>` : '';
                    
                    html += `<tr ${stilo}>
                        <td>${aluno.nome}</td>
                        ${ruralTd}
                        <td>${badgeLaudo}</td>
                        <td>${badgeTransf}</td>
                        <td><strong>${aluno.nivel || '-'}</strong></td>
                    </tr>`;
                }
            });

            if (!exibiuAlunos) {
                html += `<tr><td colspan="${isRural ? 5 : 4}" style="text-align:center; padding: 20px;">Nenhum aluno corresponde ao filtro selecionado.</td></tr>`;
            }

            html += '</tbody></table>';
            document.getElementById('modal-body').innerHTML = html;
        };

        window.abrirModalTurma = (id, isAdmin) => {
            const listaBase = isAdmin ? todosDadosAdm : meusEnviosCache;
            const item = listaBase.find(d => d.id === id);
            
            if(item) {
                turmaAtualEdicao = JSON.parse(JSON.stringify(item)); 
                if(!turmaAtualEdicao.detalhes) turmaAtualEdicao.detalhes = [];
                
                document.getElementById('modal-titulo').innerText = `${item.escola} | ${item.serie} ${item.turma} (${item.data_avaliacao})`;
                
                renderizarTabelaModal(!isAdmin);

                const footer = document.getElementById('modal-footer');
                if (isAdmin) { footer.classList.add('hidden'); } else { footer.classList.remove('hidden'); }
                
                document.getElementById('modal-detalhes').classList.remove('hidden');
            }
        };

        window.salvarEdicaoModal = async () => {
            const btn = document.querySelector('#modal-footer .btn-main');
            btn.innerText = "‚è≥ Salvando...";

            const ativos = turmaAtualEdicao.detalhes.filter(a => !a.transferido);
            const cont = {}; NIVEIS.forEach(n => cont[n] = 0); 
            let aval = 0, aus = 0;
            
            ativos.forEach(a => { if (a.nivel === 'Ausente') aus++; else if (a.nivel) { aval++; cont[a.nivel]++; } });

            turmaAtualEdicao.total_alunos = ativos.length;
            turmaAtualEdicao.total_avaliados = aval;
            turmaAtualEdicao.total_ausentes = aus;
            turmaAtualEdicao.resultados = cont;

            try {
                await set(ref(db, 'avaliacoes/' + turmaAtualEdicao.id), turmaAtualEdicao);
                alert("‚úÖ Altera√ß√µes salvas com sucesso!");
                fecharModal();
                carregarHistoricoProf(); 
            } catch (e) {
                console.error(e);
                alert("Erro ao salvar: " + e.message);
            } finally {
                btn.innerText = "üíæ SALVAR ALTERA√á√ïES";
            }
        };

        // --- DASHBOARD PROFESSOR ---
        window.carregarHistoricoProf = async () => {
            const dbRef = ref(db, 'avaliacoes');
            const snapshot = await get(dbRef);
            meusEnviosCache = [];
            
            // CORRE√á√ÉO: O filtro passa a exibir a lista fixa de escolas da professora
            const sel = document.getElementById('prof-filtro-escola');
            sel.innerHTML = '<option value="TODAS">Todas as Escolas</option>';
            const escolasFixas = [...usuarioAtual.escolas].sort();
            escolasFixas.forEach(e => sel.innerHTML += `<option value="${e}">${e}</option>`);

            if (snapshot.exists()) {
                const all = Object.entries(snapshot.val()).map(([key, value]) => ({ ...value, id: key }));
                meusEnviosCache = all.filter(d => d.professor && d.professor.toLowerCase().includes(usuarioAtual.nome.toLowerCase()));
                meusEnviosCache.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));
                aplicarFiltrosProf();
            } else { 
                aplicarFiltrosProf(); 
            }
        };

        window.excluirAvaliacao = async (id) => {
            if(confirm("Tem certeza que deseja EXCLUIR essa avalia√ß√£o inteira? N√£o poder√° desfazer.")) {
                try { await remove(ref(db, 'avaliacoes/' + id)); alert("Exclu√≠do!"); carregarHistoricoProf(); } 
                catch(e) { alert("Erro ao excluir: " + e.message); }
            }
        };

        window.aplicarFiltrosProf = () => {
            const fEsc = document.getElementById('prof-filtro-escola').value;
            const fSer = document.getElementById('prof-filtro-serie').value;
            const fTur = document.getElementById('prof-filtro-turma').value;
            const fMes = document.getElementById('prof-mes-filtro').value;
            const fAno = document.getElementById('prof-ano-filtro').value;

            let tAlunos=0, tFlu=0, tCrit=0, tAus=0, tAval=0, tLaudo=0;
            let html = "";

            meusEnviosCache.forEach(d => {
                let dia = "01", mes = "01", ano = "2026";
                try {
                    if(d.data_avaliacao && d.data_avaliacao.includes('/')) { [dia, mes, ano] = d.data_avaliacao.split('/'); } 
                    else if (d.data_avaliacao && d.data_avaliacao.includes('-')) { [ano, mes, dia] = d.data_avaliacao.split('-'); }
                    if(mes) mes = mes.padStart(2, '0');
                } catch(e) {}

                let mostrar = true;
                let ruralSeriesMatched = false;

                if (fEsc !== "TODAS" && d.escola !== fEsc) mostrar = false;
                if (fTur !== "TODAS" && d.turma !== fTur) mostrar = false;
                if (fMes !== "TODOS" && mes !== fMes) mostrar = false;
                if (fAno !== "TODOS" && ano !== fAno) mostrar = false;

                if (fSer !== "TODAS") {
                    if (d.serie === "Multisseriada" || d.professor === "Welma") {
                        const temAluno = d.detalhes && d.detalhes.some(a => a.serieRural === fSer && !a.transferido);
                        if (!temAluno) mostrar = false;
                        else ruralSeriesMatched = true;
                    } else if (d.serie !== fSer) {
                        mostrar = false;
                    }
                }

                if (!mostrar) return;

                let avalClass = 0, ausClass = 0, fluClass = 0, critClass = 0, laudoClass = 0, alunosClass = 0;
                
                if (d.detalhes) {
                    d.detalhes.forEach(a => {
                        if (a.transferido) return;
                        if ((d.serie === 'Multisseriada' || d.professor === 'Welma') && fSer !== "TODAS" && a.serieRural !== fSer) {
                            return; 
                        }
                        alunosClass++;
                        if (a.laudo) laudoClass++;
                        if (a.nivel === 'Ausente') { ausClass++; } 
                        else if (a.nivel) {
                            avalClass++;
                            if (a.nivel === 'Fluente') fluClass++;
                            if (["N√≠vel 1","N√≠vel 2","N√≠vel 3","N√≠vel 4"].includes(a.nivel)) critClass++;
                        }
                    });
                }

                tAlunos += alunosClass;
                tAval += avalClass;
                tAus += ausClass;
                tLaudo += laudoClass;
                tFlu += fluClass;
                tCrit += critClass;

                const txtEscola = d.escola || "Escola?"; 
                let txtSerie = d.serie || "?"; 
                const txtTurma = d.turma || "?"; 
                const txtData = d.data_avaliacao || "Data?";
                
                if ((d.serie === 'Multisseriada' || d.professor === 'Welma') && ruralSeriesMatched) {
                    txtSerie += `<br><small style="color:var(--primary); font-weight:bold;">(${fSer})</small>`;
                }

                html += `<tr>
                    <td>${txtEscola}<br><small>${txtSerie} - ${txtTurma}</small></td>
                    <td>${txtData}</td>
                    <td>
                        <button class="btn-table" title="Inspecionar e Editar" onclick="abrirModalTurma('${d.id}', false)">üîç</button>
                        <button class="btn-table" title="Excluir Turma Inteira" onclick="excluirAvaliacao('${d.id}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });

            document.getElementById('tabela-prof').innerHTML = html || "<tr><td colspan='3'>Nenhum dado encontrado com este filtro.</td></tr>";
            
            const pctFluente = tAval > 0 ? (tFlu/tAval*100).toFixed(1) : 0;
            const pctCritico = tAval > 0 ? (tCrit/tAval*100).toFixed(1) : 0;
            const pctAusente = tAlunos > 0 ? (tAus/tAlunos*100).toFixed(1) : 0;

            document.getElementById('prof-total').innerText = tAval;
            document.getElementById('prof-fluente').innerText = pctFluente + "%";
            document.getElementById('prof-critico').innerText = pctCritico + "%";
            document.getElementById('prof-ausente').innerText = pctAusente + "%";
            document.getElementById('prof-laudo').innerText = tLaudo;
        };

        // --- EVOLU√á√ÉO ---
        window.prepararComparativo = () => {
            const select = document.getElementById('filtro-evo-turma');
            select.innerHTML = '<option value="">Selecione...</option>';
            const chavesUnicas = new Set();
            meusEnviosCache.forEach(d => { chavesUnicas.add(`${d.escola}|${d.serie}|${d.turma}`); });
            chavesUnicas.forEach(key => { const [esc, ser, tur] = key.split('|'); const opt = document.createElement('option'); opt.value = key; opt.innerText = `${esc} - ${ser} ${tur}`; select.appendChild(opt); });
        };

        window.gerarRelatorioEvolucao = () => {
            const key = document.getElementById('filtro-evo-turma').value;
            if(!key) return alert("Selecione uma turma.");
            const [esc, ser, tur] = key.split('|');
            const avaliacoesTurma = meusEnviosCache.filter(d => d.escola === esc && d.serie === ser && d.turma === tur);
            avaliacoesTurma.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));

            if(avaliacoesTurma.length < 2) {
                document.getElementById('tabela-evo').innerHTML = "<tr><td colspan='4'>Precisa de pelo menos 2 avalia√ß√µes.</td></tr>";
                document.getElementById('resultado-evo').classList.remove('hidden'); return;
            }
            const atual = avaliacoesTurma[0]; const anterior = avaliacoesTurma[1];
            document.getElementById('evo-info').innerText = `Comparando: ${atual.data_avaliacao} vs ${anterior.data_avaliacao}`;

            let html = "";
            if(atual.detalhes) {
                atual.detalhes.forEach(alunoAtual => {
                    if(alunoAtual.transferido) return; 

                    const alunoAnt = anterior.detalhes ? anterior.detalhes.find(a => a.nome.toLowerCase().trim() === alunoAtual.nome.toLowerCase().trim()) : null;
                    const nivelAtual = alunoAtual.nivel || "-";
                    const nivelAnt = alunoAnt ? (alunoAnt.nivel || "-") : "Novo";
                    let badge = '<span class="badge badge-same">‚ûñ Manteve</span>';
                    if (alunoAnt && PESO_NIVEL[nivelAtual] !== undefined && PESO_NIVEL[nivelAnt] !== undefined) {
                        if (PESO_NIVEL[nivelAtual] > PESO_NIVEL[nivelAnt]) badge = '<span class="badge badge-up">‚¨ÜÔ∏è Evoluiu</span>';
                        else if (PESO_NIVEL[nivelAtual] < PESO_NIVEL[nivelAnt]) badge = '<span class="badge badge-down">‚¨áÔ∏è Regrediu</span>';
                    } else if (nivelAnt === "Novo") { badge = '<span class="badge" style="background:#e3f2fd; color:#1565C0;">üÜï Novo</span>'; }
                    html += `<tr><td>${alunoAtual.nome}</td><td>${nivelAnt}</td><td><strong>${nivelAtual}</strong></td><td>${badge}</td></tr>`;
                });
            }
            document.getElementById('tabela-evo').innerHTML = html;
            document.getElementById('resultado-evo').classList.remove('hidden');
        };

        // --- DASHBOARD ADMIN ---
        window.carregarAdmin = async () => {
            const dbRef = ref(db, 'avaliacoes');
            const snapshot = await get(dbRef);
            if (snapshot.exists()) {
                const all = Object.entries(snapshot.val()).map(([key, value]) => ({ ...value, id: key }));
                todosDadosAdm = all.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));
                
                const escolasUnicas = [...new Set(todosDadosAdm.map(d => d.escola))].sort();
                const selEscola = document.getElementById('filtro-escola');
                selEscola.innerHTML = '<option value="TODAS">Todas as Escolas</option>';
                escolasUnicas.forEach(esc => selEscola.innerHTML += `<option value="${esc}">${esc}</option>`);
                aplicarFiltros();
            } else { document.getElementById('tabela-envios').innerHTML = "<tr><td colspan='6'>Nenhum dado.</td></tr>"; }
        };

        window.aplicarFiltros = () => {
            const fEscola = document.getElementById('filtro-escola').value;
            const chkSeries = Array.from(document.querySelectorAll('#chk-series input:checked')).map(c => c.value);
            const fDia = document.getElementById('adm-dia-ini').value;
            let gAlunos=0, gFlu=0, gCrit=0, gAus=0, gAval=0, gLaudo=0;
            let htmlTabela = "";
            
            todosDadosAdm.forEach(d => {
                if (fEscola !== "TODAS" && d.escola !== fEscola) return;
                
                let dia, mes, ano;
                try {
                    if(d.data_avaliacao.includes('/')) { [dia, mes, ano] = d.data_avaliacao.split('/'); } 
                    else { [ano, mes, dia] = d.data_avaliacao.split('-'); }
                    dia = dia.padStart(2, '0');
                } catch(e) { return; }

                if(fDia && dia !== fDia) return;

                let contribuiu = false; 
                let tAval = 0, tFlu = 0;
                let ruralSeriesMatched = new Set(); 

                if (d.serie === 'Multisseriada' || d.professor === 'Welma') {
                    if (d.detalhes && Array.isArray(d.detalhes)) {
                        d.detalhes.forEach(aluno => {
                            if(aluno.transferido) return;
                            
                            if (chkSeries.length > 0 && chkSeries.includes(aluno.serieRural)) {
                                gAlunos++;
                                if (aluno.nivel === 'Ausente') { gAus++; }
                                else if (aluno.nivel) {
                                    gAval++; tAval++;
                                    if (aluno.nivel === 'Fluente') { gFlu++; tFlu++; }
                                    if (["N√≠vel 1","N√≠vel 2","N√≠vel 3","N√≠vel 4"].includes(aluno.nivel)) gCrit++;
                                }
                                if(aluno.laudo) gLaudo++;
                                contribuiu = true;
                                ruralSeriesMatched.add(aluno.serieRural); 
                            }
                        });
                    }
                } else {
                    if (chkSeries.length > 0 && chkSeries.includes(d.serie)) {
                        gAlunos += d.total_alunos || 0; gAus += d.total_ausentes || 0; gAval += d.total_avaliados || 0;
                        if(d.detalhes) { d.detalhes.forEach(a => { if(a.laudo && !a.transferido) gLaudo++; }); }
                        if(d.resultados) {
                            const flu = (d.resultados["Fluente"] || 0);
                            gFlu += flu; tFlu += flu; tAval += d.total_avaliados || 0;
                            gCrit += ((d.resultados["N√≠vel 1"]||0) + (d.resultados["N√≠vel 2"]||0) + (d.resultados["N√≠vel 3"]||0) + (d.resultados["N√≠vel 4"]||0));
                        }
                        contribuiu = true;
                    }
                }
                
                if (contribuiu) {
                    let pct = tAval > 0 ? (tFlu/tAval*100).toFixed(0)+"%" : "-";
                    let exibeSerie = d.serie;
                    
                    if ((d.serie === 'Multisseriada' || d.professor === 'Welma') && ruralSeriesMatched.size > 0 && ruralSeriesMatched.size < 5) {
                        let arrS = Array.from(ruralSeriesMatched).sort();
                        exibeSerie += `<br><small style="color:var(--primary); font-weight:bold;">(${arrS.join(', ')})</small>`;
                    }

                    htmlTabela += `<tr>
                        <td>${d.escola}</td><td>${exibeSerie} ${d.turma}</td><td>${d.data_avaliacao}</td><td>${d.professor}</td><td>${pct}</td>
                        <td><button class="btn-table" title="Inspecionar Avalia√ß√£o" onclick="abrirModalTurma('${d.id}', true)">üîç</button></td>
                    </tr>`;
                }
            });
            document.getElementById('tabela-envios').innerHTML = htmlTabela || "<tr><td colspan='6'>Sem dados.</td></tr>";
            document.getElementById('adm-total').innerText = gAval;
            document.getElementById('adm-fluente').innerText = gAval > 0 ? (gFlu/gAval*100).toFixed(1)+"%" : "0%";
            document.getElementById('adm-critico').innerText = gAval > 0 ? (gCrit/gAval*100).toFixed(1)+"%" : "0%";
            document.getElementById('adm-ausente').innerText = gAlunos > 0 ? (gAus/gAlunos*100).toFixed(1)+"%" : "0%";
            document.getElementById('adm-laudo').innerText = gLaudo;
        };
    </script>
</body>
</html>
