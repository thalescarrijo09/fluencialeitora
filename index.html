<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAVEL - Sistema Oficial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* TEMA LARANJA INSTITUCIONAL */
        :root { 
            --primary: #E65100; 
            --secondary: #1565C0; 
            --bg-light: #f4f4f9; 
            --text: #333; 
            --red: #d32f2f; 
            --purple: #8e24aa; 
            --gray: #9e9e9e; 
            --success: #2E7D32; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-light); color: var(--text); margin:0; padding:10px; }
        
        .screen { display: none; max-width: 950px; margin: 0 auto; }
        .screen.active { display: block; }

        /* Login */
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; margin-top: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin-left: auto; margin-right: auto; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        .logos-login { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; align-items: center; }
        .logos-login img { max-height: 120px; max-width: 180px; object-fit: contain; }

        /* Header */
        .app-header { background: var(--primary); color: white; padding: 15px; border-radius: 0 0 12px 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-logout { background: rgba(0,0,0,0.2); border: none; color: white; padding: 5px 12px; border-radius: 4px; cursor: pointer; }

        /* ABAS */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e0e0e0; border-radius: 8px; font-weight: bold; cursor: pointer; color: #555; white-space: nowrap; min-width: 100px; }
        .tab-btn.active { background: var(--secondary); color: white; }

        /* Componentes */
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* Alunos e Tabelas */
        .aluno-row { background: white; padding: 10px; margin-bottom: 5px; border-left: 5px solid #ccc; border-radius: 6px; transition: 0.3s; }
        .aluno-row.avaliado { border-left-color: var(--primary); background: #FFF3E0; } 
        .aluno-row.ausente { border-left-color: var(--red); background: #ffebee; }
        .aluno-row.transferido { border-left-color: var(--gray); background: #f0f0f0; opacity: 0.7; }
        .aluno-row.transferido strong { text-decoration: line-through; color: #777; }
        
        .controls { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
        select { padding: 8px; border-radius: 4px; flex: 1; border: 1px solid #ccc; }
        .laudo-chk { background: #eee; padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        
        /* Tabela Comparativa */
        .comp-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .comp-table th { background: #f0f0f0; padding: 8px; text-align: left; color: #555; }
        .comp-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .badge-up { background: #e8f5e9; color: var(--success); }
        .badge-down { background: #ffebee; color: var(--red); }
        .badge-same { background: #f5f5f5; color: #777; }
        
        /* Dashboard KPI */
        .dash-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 15px; justify-content: center; }
        .kpi-card { background: white; padding: 15px 10px; text-align: center; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-num { font-size: 1.4rem; font-weight: bold; color: var(--secondary); pointer-events: none; }
        .kpi-label { font-size: 0.75rem; color: #666; margin-top: 5px; font-weight: bold; pointer-events: none; }
        
        /* Efeito Clic√°vel para os Cards de N√≠vel */
        .hover-card { cursor: pointer; border: 1px solid transparent; transition: transform 0.2s, box-shadow 0.2s, border 0.2s; }
        .hover-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(230, 81, 0, 0.2); border: 1px solid var(--primary); }

        /* Barra de Resumo */
        .stats-bar { display: flex; gap: 15px; font-size: 0.9rem; background: white; padding: 6px 18px; border-radius: 20px; border: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .stats-bar span { display: flex; align-items: center; gap: 5px; }

        .adm-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .adm-table th, .adm-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        
        /* Bot√µes de A√ß√£o na Tabela */
        .btn-table { padding: 6px 8px; border: none; background: transparent; border-radius: 4px; cursor: pointer; font-size: 1.1rem; margin-right: 5px; transition: background 0.2s; }
        .btn-table:hover { background: #e0e0e0; }

        /* Pagina√ß√£o */
        .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 15px; flex-wrap: wrap; }
        .page-btn { padding: 6px 12px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; color: var(--text); transition: 0.2s; }
        .page-btn:hover:not(:disabled) { background: #eee; }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Filtros */
        .filter-container { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
        .chk-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .chk-label { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; background: #eee; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .chk-label:has(input:checked) { background: #FFE0B2; border: 1px solid var(--primary); } 
        .date-select-group { display: flex; gap: 3px; align-items: center; }
        .date-select-group select { padding: 6px; font-size: 0.85rem; min-width: 60px; }

        /* Utilit√°rios */
        .hidden { display: none !important; }
        .tag-laudo { color: var(--red); font-weight: bold; font-size: 0.75rem; display: none; }
        .aluno-row.com-laudo .tag-laudo { display: inline; }
        .action-bar { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-tool { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; }

        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; }
        .modal-content { background: white; width: 100%; max-width: 700px; border-radius: 10px; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; border-radius: 10px 10px 0 0; }
        .modal-header h3 { margin: 0; font-size: 1.1rem; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; background: #f9f9f9; border-radius: 0 0 10px 10px; }
        .close-btn { background: transparent; border: none; font-size: 1.2rem; cursor: pointer; color: white; font-weight: bold; }
        .modal-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .modal-table th, .modal-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        .modal-table tr.transferido { background: #f0f0f0; opacity: 0.7; }
        .modal-table tr.transferido td:first-child { text-decoration: line-through; color: #777; }
        
        @media print { .no-print { display: none !important; } }
        @media (max-width: 700px) { 
            .dash-grid { grid-template-columns: repeat(3, 1fr); } 
            .tabs { flex-wrap: wrap; } 
            .filter-row { flex-direction: column; align-items: stretch; }
            .stats-bar { justify-content: center; width: 100%; }
        }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="login-box">
            <div class="logos-login">
                <img src="logo-prefeitura.png" alt="Prefeitura" onerror="this.style.display='none'">
                <img src="logo-secretaria.png" alt="Secretaria" onerror="this.style.display='none'">
            </div>
            <p style="margin-top: 5px; font-weight: bold; font-size: 1.1rem; color: #555;">Gest√£o & Evolu√ß√£o de Leitura</p>
            <input type="text" id="email" placeholder="E-mail">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn-main" onclick="window.login()">ENTRAR</button>
            <p id="msg-login" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="screen-app" class="screen">
        <div class="app-header">
            <span id="header-user">Avaliadora</span>
            <button class="btn-logout" onclick="window.logout()">Sair</button>
        </div>

        <div class="tabs no-print">
            <button class="tab-btn active" onclick="window.mudarAbaProf('nova')" id="tab-nova">üìù Nova</button>
            <button class="tab-btn" onclick="window.mudarAbaProf('hist')" id="tab-hist">üìä Meu Painel</button>
            <button class="tab-btn" onclick="window.mudarAbaProf('evo')" id="tab-evo">üìà Evolu√ß√£o</button>
        </div>

        <div id="view-nova">
            <div id="area-config" class="card">
                <h3>Configurar Avalia√ß√£o</h3>
                <label>Data:</label>
                <div class="date-select-group" style="margin-bottom:10px;">
                    <select id="sel-dia"></select>
                    <select id="sel-mes"><option value="01">Jan</option><option value="02">Fev</option><option value="03">Mar</option><option value="04">Abr</option><option value="05">Mai</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Ago</option><option value="09">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option></select>
                    <select id="sel-ano"><option value="2026">2026</option><option value="2025">2025</option></select>
                </div>
                <label>Escola:</label>
                <select id="sel-escola" style="width:100%; margin-bottom:10px;" onchange="window.verificarHistoricoTurma()"></select>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;"><label>S√©rie:</label><select id="sel-serie" style="width:100%;" onchange="window.verificarHistoricoTurma()"></select></div>
                    <div style="flex:1;">
                        <label>Turma:</label>
                        <select id="sel-turma" style="width:100%;" onchange="window.verificarHistoricoTurma()">
                            <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
                            <option>F</option><option>G</option><option>H</option><option>I</option><option>J</option><option>K</option>
                            <option>Unica</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <label style="margin:0;">Alunos:</label>
                    <small id="msg-importacao" style="font-weight:bold; display:none;"></small>
                </div>
                <textarea id="lista-alunos" style="width:100%; height:100px; border-radius:8px; border:1px solid #ccc;"></textarea>
                <button class="btn-main" onclick="window.iniciarAvaliacao()">COME√áAR</button>
            </div>

            <div id="area-avaliacao" class="hidden">
                <div class="action-bar no-print">
                    <button class="btn-tool" style="background:#1565C0;" onclick="window.salvarNaNuvem()">‚òÅÔ∏è SALVAR NO BANCO</button>
                    <button class="btn-tool" style="background:#D32F2F;" onclick="window.gerarPDF()">üìÑ GERAR PDF</button>
                    <button class="btn-tool" style="background:var(--success);" onclick="window.compartilharZap()">üì± COMPARTILHAR ZAP</button>
                </div>
                <div class="card" style="border-left:5px solid var(--secondary);">
                    <h3 id="resumo-titulo" style="margin:0;">Escola</h3>
                    <p style="margin:5px 0; color:#666;"><span id="resumo-data">--</span> | <span id="resumo-sub">Turma</span></p>
                    <div id="stats-rapido" style="font-weight:bold;">0 Avaliados</div>
                </div>
                <div id="container-alunos"></div>
                <div class="card no-print" style="background:#eee; text-align:center;">
                    <input type="text" id="extra-nome" placeholder="Aluno extra..." style="width:70%;">
                    <button onclick="window.addExtra()" style="width:20%; padding:10px;">+</button>
                </div>
                <button class="btn-main no-print" style="background:#666;" onclick="window.voltarConfig()">VOLTAR E DESCARTAR</button>
            </div>
        </div>

        <div id="view-hist" class="hidden">
            <div class="filter-container">
                <div style="margin-bottom:5px; font-weight:bold; color:#555; font-size:0.9rem;">Filtrar meus dados:</div>
                <div class="filter-row">
                    <select id="prof-filtro-escola" onchange="window.aplicarFiltrosProf()"><option value="TODAS">Todas as Escolas</option></select>
                    <select id="prof-filtro-serie" onchange="window.aplicarFiltrosProf()">
                        <option value="TODAS">Todas as S√©ries</option>
                        <option value="1¬∫ Ano">1¬∫ Ano</option><option value="2¬∫ Ano">2¬∫ Ano</option><option value="3¬∫ Ano">3¬∫ Ano</option><option value="4¬∫ Ano">4¬∫ Ano</option><option value="5¬∫ Ano">5¬∫ Ano</option><option value="Multisseriada">Multisseriada</option>
                    </select>
                    <select id="prof-filtro-turma" onchange="window.aplicarFiltrosProf()">
                        <option value="TODAS">Todas as Turmas</option>
                        <option value="A">Turma A</option><option value="B">Turma B</option><option value="C">Turma C</option><option value="D">Turma D</option><option value="E">Turma E</option><option value="F">Turma F</option><option value="G">Turma G</option><option value="H">Turma H</option><option value="I">Turma I</option><option value="J">Turma J</option><option value="K">Turma K</option><option value="Unica">√önica</option>
                    </select>
                </div>
                
                <div class="filter-row" style="background:#eee; padding:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <span style="font-size:0.8rem; font-weight:bold;">Filtrar Data:</span>
                        <div class="date-select-group">
                            <select id="prof-mes-filtro" onchange="window.aplicarFiltrosProf()">
                                <option value="TODOS">M√™s (Todos)</option>
                                <option value="01">Janeiro</option><option value="02">Fevereiro</option><option value="03">Mar√ßo</option><option value="04">Abril</option><option value="05">Maio</option><option value="06">Junho</option><option value="07">Julho</option><option value="08">Agosto</option><option value="09">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                            </select>
                            <select id="prof-ano-filtro" onchange="window.aplicarFiltrosProf()">
                                <option value="TODOS">Todos os Anos</option>
                                <option value="2026">2026</option><option value="2025">2025</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="stats-bar">
                        <span style="color:var(--secondary)"><strong>Avaliados:</strong> <span id="prof-total">0</span></span>
                        <span style="color:var(--orange)"><strong>Ausentes:</strong> <span id="prof-ausente">0</span></span>
                        <span style="color:var(--purple)"><strong>Laudos:</strong> <span id="prof-laudo">0</span></span>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                    <button class="btn-main" style="width: auto; padding: 6px 12px; margin: 0; font-size: 0.85rem; background: var(--secondary);" onclick="window.abrirModalRelatorioAvancado(true)">üìÑ Relat√≥rio M√∫ltiplo</button>
                </div>
            </div>

            <div class="dash-grid">
                <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('N√≠vel 1', true)" title="Clique para ver os alunos"><div class="kpi-num" id="prof-n1" style="color:var(--red);">0%</div><div class="kpi-label">N√≠vel 1</div></div>
                <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('N√≠vel 2', true)" title="Clique para ver os alunos"><div class="kpi-num" id="prof-n2" style="color:var(--red);">0%</div><div class="kpi-label">N√≠vel 2</div></div>
                <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('N√≠vel 3', true)" title="Clique para ver os alunos"><div class="kpi-num" id="prof-n3" style="color:var(--orange);">0%</div><div class="kpi-label">N√≠vel 3</div></div>
                <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('N√≠vel 4', true)" title="Clique para ver os alunos"><div class="kpi-num" id="prof-n4" style="color:var(--orange);">0%</div><div class="kpi-label">N√≠vel 4</div></div>
                <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('Iniciante', true)" title="Clique para ver os alunos"><div class="kpi-num" id="prof-ini" style="color:var(--primary);">0%</div><div class="kpi-label">Iniciante</div></div>
                <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('Fluente', true)" title="Clique para ver os alunos"><div class="kpi-num" id="prof-flu" style="color:var(--success);">0%</div><div class="kpi-label">Fluente</div></div>
            </div>

            <div class="card">
                <h3>Minhas Turmas</h3>
                <button onclick="window.carregarHistoricoProf()" style="float:right; font-size:0.7rem;">Atualizar</button>
                <table class="adm-table">
                    <thead><tr><th>Turma</th><th>Data</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="tabela-prof"></tbody>
                </table>
                <div id="paginacao-prof" class="pagination"></div>
            </div>
        </div>

        <div id="view-evo" class="hidden">
            <div class="card">
                <h3>üîç Comparar Turma</h3>
                <label>Selecione a Turma:</label>
                <select id="filtro-evo-turma" style="width:100%; margin-bottom:10px;"><option value="">Carregando...</option></select>
                <button class="btn-main" onclick="window.gerarRelatorioEvolucao()" style="padding:10px;">GERAR COMPARATIVO</button>
            </div>
            <div id="resultado-evo" class="hidden">
                <div class="card">
                    <h4>Resultado Comparativo</h4>
                    <p id="evo-info" style="font-size:0.9rem; color:#666;"></p>
                    <table class="comp-table">
                        <thead><tr><th>Aluno</th><th>Antes</th><th>Agora</th><th>Evolu√ß√£o</th></tr></thead>
                        <tbody id="tabela-evo"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div class="app-header" style="background:#333;">
            <span>Painel Gestor</span>
            <button class="btn-logout" onclick="window.logout()">Sair</button>
        </div>

        <div class="filter-container">
            <div style="margin-bottom:10px; font-weight:bold; color:#555;">Filtros:</div>
            <div class="filter-row">
                <select id="filtro-escola" onchange="window.aplicarFiltros()" style="max-width:200px;"><option value="TODAS">Todas as Escolas</option></select>
            </div>
            
            <div class="filter-row" style="margin-bottom: 15px;">
                <div class="chk-group" id="chk-series">
                    <label class="chk-label"><input type="checkbox" value="1¬∫ Ano" checked onchange="window.aplicarFiltros()"> 1¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="2¬∫ Ano" checked onchange="window.aplicarFiltros()"> 2¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="3¬∫ Ano" checked onchange="window.aplicarFiltros()"> 3¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="4¬∫ Ano" checked onchange="window.aplicarFiltros()"> 4¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="5¬∫ Ano" checked onchange="window.aplicarFiltros()"> 5¬∫</label>
                </div>
                <button onclick="window.carregarAdmin()" style="background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-left:auto;">üîÑ Atualizar</button>
            </div>

            <div class="filter-row" style="background:#eee; padding:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <span style="font-size:0.8rem; font-weight:bold;">Filtrar Data:</span>
                    <div class="date-select-group">
                        <select id="adm-mes-ini" onchange="window.aplicarFiltros()">
                            <option value="TODOS">M√™s (Todos)</option>
                            <option value="01">Jan</option><option value="02">Fev</option><option value="03">Mar</option><option value="04">Abr</option><option value="05">Mai</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Ago</option><option value="09">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option>
                        </select>
                        <select id="adm-ano-ini" onchange="window.aplicarFiltros()">
                            <option value="TODOS">Todos os Anos</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>
                
                <div class="stats-bar">
                    <span style="color:var(--secondary)"><strong>Avaliados:</strong> <span id="adm-total">0</span></span>
                    <span style="color:var(--orange)"><strong>Ausentes:</strong> <span id="adm-ausente">0</span></span>
                    <span style="color:var(--purple)"><strong>Laudos:</strong> <span id="adm-laudo">0</span></span>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                <button class="btn-main" style="width: auto; padding: 6px 12px; margin: 0; font-size: 0.85rem; background: var(--secondary);" onclick="window.abrirModalRelatorioAvancado(false)">üìÑ Relat√≥rio M√∫ltiplo</button>
            </div>
        </div>

        <div class="dash-grid">
            <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('N√≠vel 1', false)" title="Clique para ver os alunos"><div class="kpi-num" id="adm-n1" style="color:var(--red);">0%</div><div class="kpi-label">N√≠vel 1</div></div>
            <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('N√≠vel 2', false)" title="Clique para ver os alunos"><div class="kpi-num" id="adm-n2" style="color:var(--red);">0%</div><div class="kpi-label">N√≠vel 2</div></div>
            <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('N√≠vel 3', false)" title="Clique para ver os alunos"><div class="kpi-num" id="adm-n3" style="color:var(--orange);">0%</div><div class="kpi-label">N√≠vel 3</div></div>
            <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('N√≠vel 4', false)" title="Clique para ver os alunos"><div class="kpi-num" id="adm-n4" style="color:var(--orange);">0%</div><div class="kpi-label">N√≠vel 4</div></div>
            <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('Iniciante', false)" title="Clique para ver os alunos"><div class="kpi-num" id="adm-ini" style="color:var(--primary);">0%</div><div class="kpi-label">Iniciante</div></div>
            <div class="kpi-card hover-card" onclick="window.abrirModalIntervencao('Fluente', false)" title="Clique para ver os alunos"><div class="kpi-num" id="adm-flu" style="color:var(--success);">0%</div><div class="kpi-label">Fluente</div></div>
        </div>

        <div class="card">
            <h3>Registros</h3>
            <table class="adm-table">
                <thead><tr><th>Escola</th><th>Turma</th><th>Data</th><th>Avaliador(a)</th><th>Flu√™ncia</th><th>A√ß√µes</th></tr></thead>
                <tbody id="tabela-envios"></tbody>
            </table>
            <div id="paginacao-adm" class="pagination"></div>
        </div>
    </div>

    <div id="modal-detalhes" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-titulo">Detalhes da Turma</h3>
                <button class="close-btn" onclick="window.fecharModal()">X</button>
            </div>
            <div class="modal-body" id="modal-body">
                </div>
            <div class="modal-footer hidden" id="modal-footer">
                <button class="btn-main" onclick="window.salvarEdicaoModal()" style="margin:0;">üíæ SALVAR ALTERA√á√ïES</button>
            </div>
        </div>
    </div>

    <div id="modal-intervencao" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: var(--secondary);">
                <h3 id="modal-interv-titulo">Foco Pedag√≥gico</h3>
                <button class="close-btn" onclick="document.getElementById('modal-intervencao').classList.add('hidden')">X</button>
            </div>
            <div class="modal-body" style="background: white;">
                <div id="conteudo-pdf-intervencao">
                    </div>
            </div>
            <div class="modal-footer" style="text-align: center;">
                <button class="btn-main" id="modal-interv-btn-print" onclick="window.imprimirIntervencao()" style="width: auto; padding: 10px 20px; display: inline-block;">üñ®Ô∏è GERAR PDF DA LISTA</button>
            </div>
        </div>
    </div>

    <div id="modal-relatorio-avancado" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: var(--secondary);">
                <h3 style="margin: 0; font-size: 1.1rem; color: white;">üìÑ Relat√≥rio M√∫ltiplo</h3>
                <button class="close-btn" onclick="document.getElementById('modal-relatorio-avancado').classList.add('hidden')">X</button>
            </div>
            <div class="modal-body" style="background: white;">
                <p style="margin-top: 0;">Selecione os n√≠veis que deseja agrupar no relat√≥rio:</p>
                <div class="chk-group" style="margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 8px;">
                    <label class="chk-label"><input type="checkbox" value="N√≠vel 1" class="chk-nivel"> N√≠vel 1</label>
                    <label class="chk-label"><input type="checkbox" value="N√≠vel 2" class="chk-nivel"> N√≠vel 2</label>
                    <label class="chk-label"><input type="checkbox" value="N√≠vel 3" class="chk-nivel"> N√≠vel 3</label>
                    <label class="chk-label"><input type="checkbox" value="N√≠vel 4" class="chk-nivel"> N√≠vel 4</label>
                    <label class="chk-label"><input type="checkbox" value="Iniciante" class="chk-nivel"> Iniciante</label>
                    <label class="chk-label"><input type="checkbox" value="Fluente" class="chk-nivel"> Fluente</label>
                </div>
                <button class="btn-main" onclick="window.gerarVisualizacaoRelatorioAvancado()" style="padding: 10px; margin-top: 0; margin-bottom: 15px;">üëÅÔ∏è VISUALIZAR LISTA</button>

                <div id="conteudo-pdf-avancado">
                    </div>
            </div>
            <div class="modal-footer" style="text-align: center;">
                <button class="btn-main" id="btn-print-avancado" onclick="window.imprimirRelatorioAvancado()" style="width: auto; padding: 10px 20px; display: none;">üñ®Ô∏è GERAR PDF DA LISTA</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, push, get, remove, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYV-OOz55TvJ7cLPfJkDP7idGL25MXxis",
            authDomain: "leituramineiros.firebaseapp.com",
            databaseURL: "https://leituramineiros-default-rtdb.firebaseio.com",
            projectId: "leituramineiros",
            storageBucket: "leituramineiros.firebasestorage.app",
            messagingSenderId: "221434879480",
            appId: "1:221434879480:web:1ca32bfc8ad743b5974a0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const PERFIS = {
            'jane@siavel.com': { nome: 'Jane', escolas: ['Paniago', 'Otal√©cio', 'Maria Eduarda', 'Salviano', 'Dom Bosco', 'Santo Ant√¥nio', 'Elias Carrijo', 'Tonico', 'Professor Juarez'], series: ['4¬∫ Ano', '5¬∫ Ano'], modo: 'padrao' },
            'wellita@siavel.com': { nome: 'Wellita', escolas: ['Paniago', 'Otal√©cio', 'Maria Eduarda', 'Salviano', 'Dom Bosco', 'Santo Ant√¥nio', 'Elias Carrijo', 'Tonico', 'Professor Juarez'], series: ['3¬∫ Ano'], modo: 'padrao' },
            'marcia@siavel.com': { nome: 'Marcia', escolas: ['Reverendo Eud√≥xio', 'Comecinho de Vida', 'Castelo Branco', 'Maria Eduarda', 'Padre Maximino', 'Dom Bosco', 'Professor Salviano Neves Amorim', 'Santo Ant√¥nio', 'Professor Juarez', 'Tonico Corredeira', 'Elias Carrijo de Souza', 'Paniago'], series: ['1¬∫ Ano', '2¬∫ Ano'], modo: 'padrao' },
            'welma@siavel.com': { nome: 'Welma', escolas: ['ESCOLA AM√âRICO CAETANO', 'ESCOLA FARROUPILHA', 'ESCOLA FARROUPILHA EXTENS√ÉO', 'ESCOLA ANTONIO ALVES', 'ESCOLA GUSTAVO ALVES', 'ESCOLA ANTONIO MESSIAS', 'ESCOLA CAIND√ÉO', 'ESCOLA SALTO', 'ESCOLA MORRO DOIS IRM√ÉOS', 'ESCOLA PINGUELA'], series: ['Multisseriada'], modo: 'rural' },
            'adm@siavel.com': { nome: 'Admin', modo: 'admin' }
        };

        const NIVEIS = ["N√≠vel 1", "N√≠vel 2", "N√≠vel 3", "N√≠vel 4", "Iniciante", "Fluente"];
        const PESO_NIVEL = { "Ausente": 0, "N√≠vel 1": 1, "N√≠vel 2": 2, "N√≠vel 3": 3, "N√≠vel 4": 4, "Iniciante": 5, "Fluente": 6 };
        
        let usuarioAtual = null;
        let dadosTurma = {};
        let meusEnviosCache = [];
        let todosDadosAdm = []; 
        let turmaAtualEdicao = null; 

        const rowsPerPage = 10;
        let currentPageProf = 1;
        let filteredProfData = []; 
        let currentPageAdm = 1;
        let filteredAdmData = [];

        let nivelImpressaoAtual = "";
        let modoRelatorioAvancadoIsProf = true; // Controla se o modal 3 foi aberto pela Prof ou pelo Adm

        (function initDias() { 
            const s = document.getElementById('sel-dia'); 
            for(let i=1; i<=31; i++){ 
                let o = document.createElement('option'); o.value = i < 10 ? "0"+i : i; o.innerText = i; s.appendChild(o.cloneNode(true));
            } 
        })();

        window.login = () => {
            const e = document.getElementById('email').value;
            const s = document.getElementById('senha').value;
            signInWithEmailAndPassword(auth, e, s).catch(err => document.getElementById('msg-login').innerText = "Erro no Login.");
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (user) {
                const email = user.email;
                if (PERFIS[email]) {
                    usuarioAtual = { ...PERFIS[email], email: email };
                    if (usuarioAtual.modo === 'admin') {
                        document.getElementById('screen-admin').classList.add('active');
                        window.carregarAdmin();
                    } else {
                        document.getElementById('screen-app').classList.add('active');
                        window.configurarInterfaceProfessor();
                        window.carregarHistoricoProf();
                    }
                } else { alert("Usu√°rio n√£o configurado."); window.logout(); }
            } else { document.getElementById('screen-login').classList.add('active'); }
        });

        window.mudarAbaProf = (aba) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            ['view-nova','view-hist','view-evo'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if(aba === 'nova') { document.getElementById('tab-nova').classList.add('active'); document.getElementById('view-nova').classList.remove('hidden'); }
            else if(aba === 'hist') { document.getElementById('tab-hist').classList.add('active'); document.getElementById('view-hist').classList.remove('hidden'); window.carregarHistoricoProf(); }
            else if(aba === 'evo') { document.getElementById('tab-evo').classList.add('active'); document.getElementById('view-evo').classList.remove('hidden'); window.prepararComparativo(); }
        };

        window.configurarInterfaceProfessor = () => {
            document.getElementById('header-user').innerText = `Ol√°, ${usuarioAtual.nome} (Avaliadora)`;
            const se = document.getElementById('sel-escola'); se.innerHTML = '<option value="">Selecione...</option>';
            usuarioAtual.escolas.forEach(esc => se.innerHTML += `<option>${esc}</option>`);
            const ss = document.getElementById('sel-serie'); ss.innerHTML = '';
            usuarioAtual.series.forEach(ser => ss.innerHTML += `<option>${ser}</option>`);
            window.mudarAbaProf('nova');
        };

        window.verificarHistoricoTurma = async () => {
            const esc = document.getElementById('sel-escola').value;
            const ser = document.getElementById('sel-serie').value;
            const tur = document.getElementById('sel-turma').value;
            const msg = document.getElementById('msg-importacao');
            const txtLista = document.getElementById('lista-alunos');

            msg.style.display = 'none';
            txtLista.value = "";
            dadosTurma = {}; 

            if(esc && ser && tur) {
                msg.innerText = "‚è≥ Buscando alunos...";
                msg.style.display = 'block';
                msg.style.color = "#f57c00";

                try {
                    const dbRef = ref(db, 'avaliacoes');
                    const snapshot = await get(dbRef);
                    
                    if (snapshot.exists()) {
                        const all = Object.values(snapshot.val());
                        const matches = all.filter(d => d.escola === esc && d.serie === ser && d.turma === tur);
                        
                        if (matches.length > 0) {
                            matches.sort((a, b) => new Date(b.data_envio || 0) - new Date(a.data_envio || 0));
                            const ultima = matches[0];
                            
                            if (ultima.detalhes && Array.isArray(ultima.detalhes)) {
                                const nomes = ultima.detalhes.map(a => a.nome).join('\n');
                                txtLista.value = nomes;
                                msg.innerText = `üìã Lista importada de ${ultima.data_avaliacao}`;
                                msg.style.color = "var(--primary)";
                            }
                        } else {
                            msg.innerText = "‚ú® Turma nova (Digite os nomes abaixo)";
                            msg.style.color = "#666";
                        }
                    } else {
                        msg.style.display = 'none';
                    }
                } catch (error) {
                    msg.style.display = 'none';
                }
            }
        };

        window.iniciarAvaliacao = () => {
            const escola = document.getElementById('sel-escola').value;
            const lista = document.getElementById('lista-alunos').value.split('\n').filter(n=>n.trim()!=='');
            const d = document.getElementById('sel-dia').value;
            const m = document.getElementById('sel-mes').value;
            const a = document.getElementById('sel-ano').value;
            if(!d) return alert("Selecione o Dia!");
            if (!escola || lista.length === 0) return alert("Preencha dados!");

            dadosTurma.alunos = lista.map(nome => ({ nome, nivel: '', laudo: false, serieRural: '', transferido: false }));

            dadosTurma.escola = escola;
            dadosTurma.serie = document.getElementById('sel-serie').value;
            dadosTurma.turma = document.getElementById('sel-turma').value;
            dadosTurma.data = `${d}/${m}/${a}`;

            window.renderizarAvaliacao();
            document.getElementById('area-config').classList.add('hidden');
            document.getElementById('area-avaliacao').classList.remove('hidden');
        };

        window.renderizarAvaliacao = () => {
            document.getElementById('resumo-titulo').innerText = dadosTurma.escola;
            document.getElementById('resumo-data').innerText = dadosTurma.data;
            document.getElementById('resumo-sub').innerText = `${dadosTurma.serie} - Turma ${dadosTurma.turma}`;
            const container = document.getElementById('container-alunos'); container.innerHTML = '';
            
            if(!dadosTurma.alunos) dadosTurma.alunos = [];

            dadosTurma.alunos.forEach((aluno, idx) => {
                const div = document.createElement('div'); div.className = 'aluno-row'; div.id = `row-${idx}`;
                let htmlSerie = '';
                if (usuarioAtual.modo === 'rural') {
                    htmlSerie = `<select class="sel-serie-rural" onchange="window.updateLocal(${idx}, this.value)" ${aluno.transferido?'disabled':''}><option value="">S√©rie...</option>${["1¬∫ Ano","2¬∫ Ano","3¬∫ Ano","4¬∫ Ano","5¬∫ Ano"].map(s=>`<option value="${s}" ${aluno.serieRural===s?'selected':''}>${s}</option>`).join('')}</select>`;
                }
                
                if(aluno.transferido) div.classList.add('transferido');

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;"><strong>${aluno.nome} <span class="tag-laudo">(LAUDO)</span></strong></div>
                    <div class="controls">
                        <label class="laudo-chk"><input type="checkbox" onchange="window.toggleLaudo(${idx})" ${aluno.laudo?'checked':''} ${aluno.transferido?'disabled':''}> Laudo</label>
                        <label class="laudo-chk" style="color:var(--red);"><input type="checkbox" onchange="window.toggleTransferido(${idx})" ${aluno.transferido?'checked':''}> Transf.</label>
                        ${htmlSerie}
                        <select onchange="window.updateNivel(${idx}, this.value)" ${aluno.transferido?'disabled':''}>
                            <option value="">Avaliar...</option><option value="Ausente">‚ö†Ô∏è Ausente</option>${NIVEIS.map(n=>`<option value="${n}" ${aluno.nivel===n?'selected':''}>${n}</option>`).join('')}
                        </select>
                    </div>`;
                container.appendChild(div);
                if(aluno.laudo) div.classList.add('com-laudo');
            });
            window.atualizarStats();
        };

        window.toggleLaudo = (idx) => { dadosTurma.alunos[idx].laudo = !dadosTurma.alunos[idx].laudo; document.getElementById(`row-${idx}`).classList.toggle('com-laudo'); };
        window.toggleTransferido = (idx) => { dadosTurma.alunos[idx].transferido = !dadosTurma.alunos[idx].transferido; if(dadosTurma.alunos[idx].transferido) { dadosTurma.alunos[idx].nivel = ""; } window.renderizarAvaliacao(); };
        window.updateNivel = (idx, val) => { dadosTurma.alunos[idx].nivel = val; const row = document.getElementById(`row-${idx}`); row.className = 'aluno-row ' + (dadosTurma.alunos[idx].laudo ? 'com-laudo' : ''); if (val === 'Ausente') row.classList.add('ausente'); else if (val) row.classList.add('avaliado'); window.atualizarStats(); };
        window.updateLocal = (idx, val) => { dadosTurma.alunos[idx].serieRural = val; };
        window.addExtra = () => { const nome = document.getElementById('extra-nome').value; if(nome) { dadosTurma.alunos.push({ nome, nivel: '', laudo: false, serieRural: '', transferido: false }); window.renderizarAvaliacao(); document.getElementById('extra-nome').value = ''; } };
        window.voltarConfig = () => { if(confirm("Voltar sem salvar?")) { document.getElementById('area-avaliacao').classList.add('hidden'); document.getElementById('area-config').classList.remove('hidden'); dadosTurma = {}; } };
        
        window.atualizarStats = () => { 
            const ativos = dadosTurma.alunos.filter(a => !a.transferido);
            const aval = ativos.filter(a => a.nivel && a.nivel !== 'Ausente').length; 
            const aus = ativos.filter(a => a.nivel === 'Ausente').length; 
            document.getElementById('stats-rapido').innerText = `Status: ${aval} Avaliados | ${aus} Ausentes`; 
        };

        window.salvarNaNuvem = async () => {
            const btn = document.querySelector('button[onclick="window.salvarNaNuvem()"]'); btn.innerText = "‚è≥ Enviando...";
            const ativos = dadosTurma.alunos.filter(a => !a.transferido);
            const cont = {}; NIVEIS.forEach(n => cont[n] = 0); let aval = 0, aus = 0;
            ativos.forEach(a => { if (a.nivel === 'Ausente') aus++; else if (a.nivel) { aval++; cont[a.nivel]++; } });
            
            const pacote = { 
                escola: dadosTurma.escola, turma: dadosTurma.turma, serie: dadosTurma.serie, professor: usuarioAtual.nome, 
                data_avaliacao: dadosTurma.data, data_envio: new Date().toISOString(), 
                total_alunos: ativos.length, total_avaliados: aval, total_ausentes: aus, 
                resultados: cont, detalhes: dadosTurma.alunos 
            };
            try { await push(ref(db, 'avaliacoes'), pacote); alert("‚úÖ Sucesso!"); btn.innerText = "‚òÅÔ∏è SALVAR NO BANCO"; document.getElementById('lista-alunos').value = ""; document.getElementById('area-avaliacao').classList.add('hidden'); document.getElementById('area-config').classList.remove('hidden'); dadosTurma = {}; } catch (e) { console.error(e); alert("Erro: " + e.message); btn.innerText = "‚òÅÔ∏è Tentar Novamente"; }
        };

        window.gerarPDF = () => { const el = document.getElementById('area-avaliacao'); document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none'); html2pdf().from(el).save(`${dadosTurma.escola}.pdf`).then(() => { document.querySelectorAll('.no-print').forEach(e => e.style.display = ''); }); };
        window.compartilharZap = () => { let txt = `*${dadosTurma.escola}*\nData: ${dadosTurma.data}\nAv: ${dadosTurma.alunos.filter(a=>a.nivel&&a.nivel!='Ausente' && !a.transferido).length}\n\n`; dadosTurma.alunos.forEach(a => { if(!a.transferido && a.nivel) txt += `${a.nivel==='Ausente'?'‚ö†Ô∏è':'‚úÖ'} ${a.nome}: ${a.nivel}\n`; }); window.open("https://wa.me/?text=" + encodeURIComponent(txt)); };

        // ==========================================
        // L√ìGICA DO MODAL DE INSPE√á√ÉO E EDI√á√ÉO (TURMA)
        // ==========================================
        
        window.fecharModal = () => {
            document.getElementById('modal-detalhes').classList.add('hidden');
            turmaAtualEdicao = null;
        };

        window.renderizarTabelaModal = (isProf) => {
            const isRural = turmaAtualEdicao.serie === 'Multisseriada' || turmaAtualEdicao.professor === 'Welma';
            let profFiltroSerie = 'TODAS';
            let admChkSeries = [];
            if (isRural) {
                if (isProf) { profFiltroSerie = document.getElementById('prof-filtro-serie').value; } 
                else { admChkSeries = Array.from(document.querySelectorAll('#chk-series input:checked')).map(c => c.value); }
            }

            let html = '<table class="modal-table"><thead><tr><th>Aluno</th>';
            if (isRural) html += '<th>S√©rie</th>';
            html += '<th>Laudo</th><th>Transf.</th><th>Avalia√ß√£o</th></tr></thead><tbody>';
            let exibiuAlunos = false;

            turmaAtualEdicao.detalhes.forEach((aluno, idx) => {
                if (isRural) {
                    if (isProf && profFiltroSerie !== "TODAS" && aluno.serieRural !== profFiltroSerie) return; 
                    if (!isProf && admChkSeries.length > 0 && !admChkSeries.includes(aluno.serieRural)) return; 
                }
                exibiuAlunos = true;

                if (isProf) {
                    let options = `<option value="">- Sem Nota -</option><option value="Ausente" ${aluno.nivel==='Ausente'?'selected':''}>Ausente</option>`;
                    NIVEIS.forEach(n => { options += `<option value="${n}" ${aluno.nivel===n?'selected':''}>${n}</option>`; });
                    let ruralTd = '';
                    if (isRural) {
                        ruralTd = `<td><select onchange="turmaAtualEdicao.detalhes[${idx}].serieRural = this.value" ${aluno.transferido?'disabled':''} style="padding:4px; border-radius:4px; border:1px solid #ccc; max-width:85px;">
                            <option value="">S√©rie...</option>${["1¬∫ Ano","2¬∫ Ano","3¬∫ Ano","4¬∫ Ano","5¬∫ Ano"].map(s=>`<option value="${s}" ${aluno.serieRural===s?'selected':''}>${s}</option>`).join('')}</select></td>`;
                    }
                    html += `<tr class="${aluno.transferido ? 'transferido' : ''}">
                        <td><strong>${aluno.nome}</strong></td>${ruralTd}
                        <td><input type="checkbox" onchange="turmaAtualEdicao.detalhes[${idx}].laudo = this.checked" ${aluno.laudo?'checked':''} ${aluno.transferido?'disabled':''}></td>
                        <td><input type="checkbox" onchange="turmaAtualEdicao.detalhes[${idx}].transferido = this.checked; if(this.checked){turmaAtualEdicao.detalhes[${idx}].nivel=''} window.renderizarTabelaModal(true)" ${aluno.transferido?'checked':''}></td>
                        <td><select onchange="turmaAtualEdicao.detalhes[${idx}].nivel = this.value" ${aluno.transferido?'disabled':''}>${options}</select></td>
                    </tr>`;
                } else {
                    let badgeTransf = aluno.transferido ? '<span style="color:var(--gray)">Sim</span>' : 'N√£o';
                    let badgeLaudo = aluno.laudo ? '<span style="color:var(--purple)">Sim</span>' : 'N√£o';
                    let stilo = aluno.transferido ? 'class="transferido"' : '';
                    let ruralTd = isRural ? `<td>${aluno.serieRural || '-'}</td>` : '';
                    html += `<tr ${stilo}><td>${aluno.nome}</td>${ruralTd}<td>${badgeLaudo}</td><td>${badgeTransf}</td><td><strong>${aluno.nivel || '-'}</strong></td></tr>`;
                }
            });

            if (!exibiuAlunos) html += `<tr><td colspan="${isRural ? 5 : 4}" style="text-align:center; padding: 20px;">Nenhum aluno corresponde ao filtro selecionado.</td></tr>`;
            html += '</tbody></table>';
            document.getElementById('modal-body').innerHTML = html;
        };

        window.abrirModalTurma = (id, isAdmin) => {
            const listaBase = isAdmin ? todosDadosAdm : meusEnviosCache;
            const item = listaBase.find(d => d.id === id);
            if(item) {
                turmaAtualEdicao = JSON.parse(JSON.stringify(item)); 
                if(!turmaAtualEdicao.detalhes) turmaAtualEdicao.detalhes = [];
                document.getElementById('modal-titulo').innerText = `${item.escola} | ${item.serie} ${item.turma} (${item.data_avaliacao})`;
                window.renderizarTabelaModal(!isAdmin);
                const footer = document.getElementById('modal-footer');
                if (isAdmin) { footer.classList.add('hidden'); } else { footer.classList.remove('hidden'); }
                document.getElementById('modal-detalhes').classList.remove('hidden');
            }
        };

        window.salvarEdicaoModal = async () => {
            const btn = document.querySelector('#modal-footer .btn-main');
            btn.innerText = "‚è≥ Salvando...";
            const ativos = turmaAtualEdicao.detalhes.filter(a => !a.transferido);
            const cont = {}; NIVEIS.forEach(n => cont[n] = 0); let aval = 0, aus = 0;
            ativos.forEach(a => { if (a.nivel === 'Ausente') aus++; else if (a.nivel) { aval++; cont[a.nivel]++; } });

            turmaAtualEdicao.total_alunos = ativos.length;
            turmaAtualEdicao.total_avaliados = aval;
            turmaAtualEdicao.total_ausentes = aus;
            turmaAtualEdicao.resultados = cont;

            try {
                await set(ref(db, 'avaliacoes/' + turmaAtualEdicao.id), turmaAtualEdicao);
                alert("‚úÖ Altera√ß√µes salvas com sucesso!");
                window.fecharModal();
                window.carregarHistoricoProf(); 
            } catch (e) {
                console.error(e);
                alert("Erro ao salvar: " + e.message);
            } finally { btn.innerText = "üíæ SALVAR ALTERA√á√ïES"; }
        };

        // ==========================================
        // NOVO: L√ìGICA DO RELAT√ìRIO AVAN√áADO (M√öLTIPLOS N√çVEIS)
        // ==========================================
        window.abrirModalRelatorioAvancado = (isProf) => {
            modoRelatorioAvancadoIsProf = isProf;
            
            // Limpa as caixinhas ao abrir
            document.querySelectorAll('.chk-nivel').forEach(chk => chk.checked = false);
            document.getElementById('conteudo-pdf-avancado').innerHTML = "";
            document.getElementById('btn-print-avancado').style.display = 'none';
            
            document.getElementById('modal-relatorio-avancado').classList.remove('hidden');
        };

        window.gerarVisualizacaoRelatorioAvancado = () => {
            const checkboxes = document.querySelectorAll('.chk-nivel:checked');
            const niveisSelecionados = Array.from(checkboxes).map(c => c.value);

            if (niveisSelecionados.length === 0) {
                alert("Selecione pelo menos um n√≠vel para gerar o relat√≥rio.");
                return;
            }

            const listaBase = modoRelatorioAvancadoIsProf ? filteredProfData : filteredAdmData;
            let temAlunos = false;
            
            let html = `<div id="documento-pdf-avancado" style="padding: 20px; font-family: 'Segoe UI', sans-serif; color: #333; background: white;">
                <div style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
                    <h2 style="color: var(--primary); margin: 0 0 5px 0;">Relat√≥rio de Interven√ß√£o Pedag√≥gica</h2>
                    <h3 style="margin: 0; color: #555; font-weight: normal;">N√≠veis: <strong style="color: black;">${niveisSelecionados.join(' | ')}</strong></h3>
                </div>`;

            listaBase.forEach(item => {
                const d = item.originalData;
                const isRural = d.serie === 'Multisseriada' || d.professor === 'Welma';
                const fSer = modoRelatorioAvancadoIsProf ? document.getElementById('prof-filtro-serie').value : "TODAS"; 
                const admChkSeries = modoRelatorioAvancadoIsProf ? [] : Array.from(document.querySelectorAll('#chk-series input:checked')).map(c => c.value);

                let alunosNesteFiltro = [];

                if (d.detalhes) {
                    d.detalhes.forEach(aluno => {
                        if (aluno.transferido) return;
                        if (!niveisSelecionados.includes(aluno.nivel)) return;

                        if (isRural) {
                            if (modoRelatorioAvancadoIsProf && fSer !== "TODAS" && aluno.serieRural !== fSer) return;
                            if (!modoRelatorioAvancadoIsProf && admChkSeries.length > 0 && !admChkSeries.includes(aluno.serieRural)) return;
                        }
                        alunosNesteFiltro.push(aluno);
                    });
                }

                if (alunosNesteFiltro.length > 0) {
                    temAlunos = true;
                    let tituloTurma = `${d.escola} | ${d.serie} ${d.turma}`;
                    if (isRural && item.exibeSerie) {
                       tituloTurma = `${d.escola} | ${item.exibeSerie.replace(/<[^>]*>?/gm, '')} ${d.turma}`;
                    }

                    html += `
                    <div style="margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; page-break-inside: avoid;">
                        <div style="background: #f4f4f9; padding: 10px; font-weight: bold; border-bottom: 1px solid #ddd; font-size: 1rem;">
                            üè´ ${tituloTurma} <span style="float: right; font-weight: normal; font-size: 0.85rem;">(${alunosNesteFiltro.length} aluno${alunosNesteFiltro.length>1?'s':''})</span>
                        </div>
                        <ul style="margin: 0; padding: 10px 15px 10px 35px; list-style-type: square; font-size: 0.95rem;">`;
                    
                    alunosNesteFiltro.forEach(a => {
                        // Identifica o n√≠vel do aluno visualmente na lista
                        let corNivel = "var(--primary)";
                        if(a.nivel === "N√≠vel 1" || a.nivel === "N√≠vel 2") corNivel = "var(--red)";
                        if(a.nivel === "N√≠vel 3" || a.nivel === "N√≠vel 4") corNivel = "var(--orange)";
                        if(a.nivel === "Fluente") corNivel = "var(--success)";

                        let infoExtra = ` <span style='color:${corNivel}; font-weight:bold; font-size: 0.85rem;'>[${a.nivel}]</span>`;
                        if(a.laudo) infoExtra += " <b style='color:var(--purple); font-size: 0.8rem;'>[Laudo]</b>";
                        if(isRural) infoExtra += ` <span style='color:var(--gray); font-size: 0.85rem;'>- ${a.serieRural}</span>`;
                        
                        html += `<li style="padding: 4px 0; border-bottom: 1px dashed #eee;">${a.nome}${infoExtra}</li>`;
                    });
                    
                    html += `</ul></div>`;
                }
            });

            html += `</div>`;

            if (!temAlunos) {
                html = `<div style="padding: 30px; text-align: center; color: #666; font-size: 1.1rem;">Nenhum aluno encontrado para os n√≠veis selecionados.<br><small>Verifique os filtros principais de M√™s e Escola.</small></div>`;
                document.getElementById('btn-print-avancado').style.display = 'none';
            } else {
                document.getElementById('btn-print-avancado').style.display = 'inline-block';
            }

            document.getElementById('conteudo-pdf-avancado').innerHTML = html;
        };

        window.imprimirRelatorioAvancado = () => {
            const btn = document.getElementById('btn-print-avancado');
            btn.innerText = "‚è≥ GERANDO PDF...";
            const el = document.getElementById('documento-pdf-avancado'); 
            
            const opt = {
                margin:       10,
                filename:     `Relatorio_Multiplo.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(el).save().then(() => {
                btn.innerText = "üñ®Ô∏è GERAR PDF DA LISTA";
            });
        };

        // L√ìGICA DO MODAL SIMPLES (1 N√çVEL) MANTIDA
        window.abrirModalIntervencao = (nivel, isProf) => {
            nivelImpressaoAtual = nivel;
            const listaBase = isProf ? filteredProfData : filteredAdmData;
            let temAlunos = false;
            
            let html = `<div id="documento-pdf" style="padding: 20px; font-family: 'Segoe UI', sans-serif; color: #333; background: white;">
                <div style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
                    <h2 style="color: var(--primary); margin: 0 0 5px 0;">Relat√≥rio de Interven√ß√£o Pedag√≥gica</h2>
                    <h3 style="margin: 0; color: #555; font-weight: normal;">Foco de An√°lise: <strong style="color: black;">${nivel}</strong></h3>
                </div>`;

            listaBase.forEach(item => {
                const d = item.originalData;
                const isRural = d.serie === 'Multisseriada' || d.professor === 'Welma';
                const fSer = isProf ? document.getElementById('prof-filtro-serie').value : "TODAS"; 
                const admChkSeries = isProf ? [] : Array.from(document.querySelectorAll('#chk-series input:checked')).map(c => c.value);

                let alunosNesteNivel = [];

                if (d.detalhes) {
                    d.detalhes.forEach(aluno => {
                        if (aluno.transferido) return;
                        if (aluno.nivel !== nivel) return;

                        if (isRural) {
                            if (isProf && fSer !== "TODAS" && aluno.serieRural !== fSer) return;
                            if (!isProf && admChkSeries.length > 0 && !admChkSeries.includes(aluno.serieRural)) return;
                        }
                        alunosNesteNivel.push(aluno);
                    });
                }

                if (alunosNesteNivel.length > 0) {
                    temAlunos = true;
                    let tituloTurma = `${d.escola} | ${d.serie} ${d.turma}`;
                    if (isRural && item.exibeSerie) {
                       tituloTurma = `${d.escola} | ${item.exibeSerie.replace(/<[^>]*>?/gm, '')} ${d.turma}`;
                    }

                    html += `
                    <div style="margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; page-break-inside: avoid;">
                        <div style="background: #f4f4f9; padding: 10px; font-weight: bold; border-bottom: 1px solid #ddd; font-size: 1rem;">
                            üè´ ${tituloTurma} <span style="float: right; font-weight: normal; font-size: 0.85rem;">(${alunosNesteNivel.length} aluno${alunosNesteNivel.length>1?'s':''})</span>
                        </div>
                        <ul style="margin: 0; padding: 10px 15px 10px 35px; list-style-type: square; font-size: 0.95rem;">`;
                    
                    alunosNesteNivel.forEach(a => {
                        let infoExtra = "";
                        if(a.laudo) infoExtra += " <b style='color:var(--purple); font-size: 0.8rem;'>[Laudo]</b>";
                        if(isRural) infoExtra += ` <span style='color:var(--gray); font-size: 0.85rem;'>- ${a.serieRural}</span>`;
                        html += `<li style="padding: 4px 0; border-bottom: 1px dashed #eee;">${a.nome}${infoExtra}</li>`;
                    });
                    
                    html += `</ul></div>`;
                }
            });

            html += `</div>`;

            if (!temAlunos) {
                html = `<div style="padding: 30px; text-align: center; color: #666; font-size: 1.1rem;">Nenhum aluno no <b>${nivel}</b> com os filtros atuais.<br><small>Tente mudar o m√™s ou a escola.</small></div>`;
                document.getElementById('modal-interv-btn-print').style.display = 'none';
            } else {
                document.getElementById('modal-interv-btn-print').style.display = 'inline-block';
            }

            document.getElementById('conteudo-pdf-intervencao').innerHTML = html;
            document.getElementById('modal-intervencao').classList.remove('hidden');
        };

        window.imprimirIntervencao = () => {
            const btn = document.getElementById('modal-interv-btn-print');
            btn.innerText = "‚è≥ GERANDO PDF...";
            const el = document.getElementById('documento-pdf'); 
            
            const opt = {
                margin:       10,
                filename:     `Intervencao_${nivelImpressaoAtual}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(el).save().then(() => {
                btn.innerText = "üñ®Ô∏è GERAR PDF DA LISTA";
            });
        };

        // ==========================================
        // DASHBOARD PROFESSOR
        // ==========================================
        window.carregarHistoricoProf = async () => {
            const dbRef = ref(db, 'avaliacoes');
            const snapshot = await get(dbRef);
            meusEnviosCache = [];
            
            const sel = document.getElementById('prof-filtro-escola');
            sel.innerHTML = '<option value="TODAS">Todas as Escolas</option>';
            const escolasFixas = [...usuarioAtual.escolas].sort();
            escolasFixas.forEach(e => sel.innerHTML += `<option value="${e}">${e}</option>`);

            if (snapshot.exists()) {
                const all = Object.entries(snapshot.val()).map(([key, value]) => ({ ...value, id: key }));
                meusEnviosCache = all.filter(d => d.professor && d.professor.toLowerCase().includes(usuarioAtual.nome.toLowerCase()));
                meusEnviosCache.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));
                window.aplicarFiltrosProf();
            } else { 
                window.aplicarFiltrosProf(); 
            }
        };

        window.excluirAvaliacao = async (id) => {
            if(confirm("Tem certeza que deseja EXCLUIR essa avalia√ß√£o inteira? N√£o poder√° desfazer.")) {
                try { await remove(ref(db, 'avaliacoes/' + id)); alert("Exclu√≠do!"); window.carregarHistoricoProf(); } 
                catch(e) { alert("Erro ao excluir: " + e.message); }
            }
        };

        window.aplicarFiltrosProf = () => {
            const fEsc = document.getElementById('prof-filtro-escola').value;
            const fSer = document.getElementById('prof-filtro-serie').value;
            const fTur = document.getElementById('prof-filtro-turma').value;
            const fMes = document.getElementById('prof-mes-filtro').value;
            const fAno = document.getElementById('prof-ano-filtro').value;

            let tAlunos=0, tAus=0, tAval=0, tLaudo=0;
            let tN1=0, tN2=0, tN3=0, tN4=0, tIni=0, tFlu=0;
            
            filteredProfData = []; 

            meusEnviosCache.forEach(d => {
                let dia = "01", mes = "01", ano = "2026";
                try {
                    if(d.data_avaliacao && d.data_avaliacao.includes('/')) { [dia, mes, ano] = d.data_avaliacao.split('/'); } 
                    else if (d.data_avaliacao && d.data_avaliacao.includes('-')) { [ano, mes, dia] = d.data_avaliacao.split('-'); }
                    if(mes) mes = mes.padStart(2, '0');
                } catch(e) {}

                let mostrar = true;
                let ruralSeriesMatched = false;

                if (fEsc !== "TODAS" && d.escola !== fEsc) mostrar = false;
                if (fTur !== "TODAS" && d.turma !== fTur) mostrar = false;
                if (fMes !== "TODOS" && mes !== fMes) mostrar = false;
                if (fAno !== "TODOS" && ano !== fAno) mostrar = false;

                if (fSer !== "TODAS") {
                    if (d.serie === "Multisseriada" || d.professor === "Welma") {
                        const temAluno = d.detalhes && d.detalhes.some(a => a.serieRural === fSer && !a.transferido);
                        if (!temAluno) mostrar = false;
                        else ruralSeriesMatched = true;
                    } else if (d.serie !== fSer) {
                        mostrar = false;
                    }
                }

                if (!mostrar) return;

                let avalClass = 0, ausClass = 0, alunosClass = 0, laudoClass = 0;
                let n1Class=0, n2Class=0, n3Class=0, n4Class=0, iniClass=0, fluClass=0;
                
                if (d.detalhes) {
                    d.detalhes.forEach(a => {
                        if (a.transferido) return;
                        if ((d.serie === 'Multisseriada' || d.professor === 'Welma') && fSer !== "TODAS" && a.serieRural !== fSer) {
                            return; 
                        }
                        alunosClass++;
                        if (a.laudo) laudoClass++;
                        if (a.nivel === 'Ausente') { ausClass++; } 
                        else if (a.nivel) {
                            avalClass++;
                            if (a.nivel === 'N√≠vel 1') n1Class++;
                            if (a.nivel === 'N√≠vel 2') n2Class++;
                            if (a.nivel === 'N√≠vel 3') n3Class++;
                            if (a.nivel === 'N√≠vel 4') n4Class++;
                            if (a.nivel === 'Iniciante') iniClass++;
                            if (a.nivel === 'Fluente') fluClass++;
                        }
                    });
                }

                tAlunos += alunosClass;
                tAval += avalClass;
                tAus += ausClass;
                tLaudo += laudoClass;
                tN1 += n1Class; tN2 += n2Class; tN3 += n3Class; tN4 += n4Class; tIni += iniClass; tFlu += fluClass;

                let txtSerie = d.serie || "?"; 
                if ((d.serie === 'Multisseriada' || d.professor === 'Welma') && ruralSeriesMatched) {
                    txtSerie += `<br><small style="color:var(--primary); font-weight:bold;">(${fSer})</small>`;
                }

                filteredProfData.push({
                    originalData: d,
                    exibeSerie: txtSerie,
                    id: d.id, escola: d.escola || "Escola?", serie: txtSerie, turma: d.turma || "?", data: d.data_avaliacao || "Data?"
                });
            });

            const pctN1 = tAval > 0 ? (tN1/tAval*100).toFixed(1) : 0;
            const pctN2 = tAval > 0 ? (tN2/tAval*100).toFixed(1) : 0;
            const pctN3 = tAval > 0 ? (tN3/tAval*100).toFixed(1) : 0;
            const pctN4 = tAval > 0 ? (tN4/tAval*100).toFixed(1) : 0;
            const pctIni = tAval > 0 ? (tIni/tAval*100).toFixed(1) : 0;
            const pctFlu = tAval > 0 ? (tFlu/tAval*100).toFixed(1) : 0;

            document.getElementById('prof-total').innerText = tAval;
            document.getElementById('prof-ausente').innerText = tAus; 
            document.getElementById('prof-laudo').innerText = tLaudo; 
            
            document.getElementById('prof-n1').innerText = pctN1 + "%";
            document.getElementById('prof-n2').innerText = pctN2 + "%";
            document.getElementById('prof-n3').innerText = pctN3 + "%";
            document.getElementById('prof-n4').innerText = pctN4 + "%";
            document.getElementById('prof-ini').innerText = pctIni + "%";
            document.getElementById('prof-flu').innerText = pctFlu + "%";

            currentPageProf = 1;
            window.renderTableProf();
            window.renderPaginationProf();
        };

        window.renderTableProf = () => {
            let html = "";
            const start = (currentPageProf - 1) * rowsPerPage;
            const pageData = filteredProfData.slice(start, start + rowsPerPage);
            if (pageData.length === 0) { html = "<tr><td colspan='3'>Nenhum dado encontrado.</td></tr>"; } 
            else {
                pageData.forEach(d => {
                    html += `<tr>
                        <td>${d.escola}<br><small>${d.serie} - ${d.turma}</small></td><td>${d.data}</td>
                        <td><button class="btn-table" onclick="window.abrirModalTurma('${d.id}', false)">üîç</button><button class="btn-table" onclick="window.excluirAvaliacao('${d.id}')">üóëÔ∏è</button></td>
                    </tr>`;
                });
            }
            document.getElementById('tabela-prof').innerHTML = html;
        };

        window.mudarPaginaProf = (page) => { currentPageProf = page; window.renderTableProf(); window.renderPaginationProf(); };

        window.renderPaginationProf = () => {
            const totalPages = Math.ceil(filteredProfData.length / rowsPerPage);
            let html = "";
            if (totalPages > 1) {
                html += `<button class="page-btn" ${currentPageProf === 1 ? 'disabled' : ''} onclick="window.mudarPaginaProf(${currentPageProf - 1})">¬´ Ant</button>`;
                for(let i=1; i<=totalPages; i++) { html += `<button class="page-btn ${currentPageProf === i ? 'active' : ''}" onclick="window.mudarPaginaProf(${i})">${i}</button>`; }
                html += `<button class="page-btn" ${currentPageProf === totalPages ? 'disabled' : ''} onclick="window.mudarPaginaProf(${currentPageProf + 1})">Pr√≥x ¬ª</button>`;
            }
            document.getElementById('paginacao-prof').innerHTML = html;
        };

        // --- EVOLU√á√ÉO ---
        window.prepararComparativo = () => {
            const select = document.getElementById('filtro-evo-turma');
            if(!select) return;
            
            select.innerHTML = '<option value="">Selecione a Turma...</option>';
            
            if (!meusEnviosCache || meusEnviosCache.length === 0) {
                select.innerHTML = '<option value="">Nenhuma avalia√ß√£o encontrada</option>';
                return;
            }

            const chavesUnicas = new Set();
            meusEnviosCache.forEach(d => { 
                const esc = d.escola || "Escola Desconhecida";
                const ser = d.serie || "S√©rie Indefinida";
                const tur = d.turma || "√önica";
                chavesUnicas.add(`${esc}|${ser}|${tur}`); 
            });
            
            Array.from(chavesUnicas).sort().forEach(key => { 
                const [esc, ser, tur] = key.split('|'); 
                const opt = document.createElement('option'); 
                opt.value = key; 
                opt.innerText = `${esc} - ${ser} ${tur}`; 
                select.appendChild(opt); 
            });
        };

        window.gerarRelatorioEvolucao = () => {
            const key = document.getElementById('filtro-evo-turma').value;
            if(!key) return alert("Selecione uma turma.");
            const [esc, ser, tur] = key.split('|');
            const avaliacoesTurma = meusEnviosCache.filter(d => 
                (d.escola || "Escola Desconhecida") === esc && 
                (d.serie || "S√©rie Indefinida") === ser && 
                (d.turma || "√önica") === tur
            );
            avaliacoesTurma.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));

            if(avaliacoesTurma.length < 2) {
                document.getElementById('tabela-evo').innerHTML = "<tr><td colspan='4'>Precisa de pelo menos 2 avalia√ß√µes.</td></tr>";
                document.getElementById('resultado-evo').classList.remove('hidden'); return;
            }
            const atual = avaliacoesTurma[0]; const anterior = avaliacoesTurma[1];
            document.getElementById('evo-info').innerText = `Comparando: ${atual.data_avaliacao} vs ${anterior.data_avaliacao}`;

            let html = "";
            if(atual.detalhes) {
                atual.detalhes.forEach(alunoAtual => {
                    if(alunoAtual.transferido) return; 

                    const alunoAnt = anterior.detalhes ? anterior.detalhes.find(a => a.nome.toLowerCase().trim() === alunoAtual.nome.toLowerCase().trim()) : null;
                    const nivelAtual = alunoAtual.nivel || "-";
                    const nivelAnt = alunoAnt ? (alunoAnt.nivel || "-") : "Novo";
                    let badge = '<span class="badge badge-same">‚ûñ Manteve</span>';
                    if (alunoAnt && PESO_NIVEL[nivelAtual] !== undefined && PESO_NIVEL[nivelAnt] !== undefined) {
                        if (PESO_NIVEL[nivelAtual] > PESO_NIVEL[nivelAnt]) badge = '<span class="badge badge-up">‚¨ÜÔ∏è Evoluiu</span>';
                        else if (PESO_NIVEL[nivelAtual] < PESO_NIVEL[nivelAnt]) badge = '<span class="badge badge-down">‚¨áÔ∏è Regrediu</span>';
                    } else if (nivelAnt === "Novo") { badge = '<span class="badge" style="background:#e3f2fd; color:#1565C0;">üÜï Novo</span>'; }
                    html += `<tr><td>${alunoAtual.nome}</td><td>${nivelAnt}</td><td><strong>${nivelAtual}</strong></td><td>${badge}</td></tr>`;
                });
            }
            document.getElementById('tabela-evo').innerHTML = html;
            document.getElementById('resultado-evo').classList.remove('hidden');
        };

        // --- DASHBOARD ADMIN ---
        window.carregarAdmin = async () => {
            const dbRef = ref(db, 'avaliacoes');
            const snapshot = await get(dbRef);
            if (snapshot.exists()) {
                const all = Object.entries(snapshot.val()).map(([key, value]) => ({ ...value, id: key }));
                todosDadosAdm = all.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));
                
                const escolasUnicas = [...new Set(todosDadosAdm.map(d => d.escola))].sort();
                const selEscola = document.getElementById('filtro-escola');
                selEscola.innerHTML = '<option value="TODAS">Todas as Escolas</option>';
                escolasUnicas.forEach(esc => selEscola.innerHTML += `<option value="${esc}">${esc}</option>`);
                window.aplicarFiltros();
            } else { document.getElementById('tabela-envios').innerHTML = "<tr><td colspan='6'>Nenhum dado.</td></tr>"; }
        };

        window.aplicarFiltros = () => {
            const fEscola = document.getElementById('filtro-escola').value;
            const chkSeries = Array.from(document.querySelectorAll('#chk-series input:checked')).map(c => c.value);
            
            let fDia = ""; let fMes = "TODOS"; let fAno = "TODOS";
            
            if (document.getElementById('adm-dia-ini')) fDia = document.getElementById('adm-dia-ini').value;
            if (document.getElementById('adm-mes-ini')) fMes = document.getElementById('adm-mes-ini').value;
            if (document.getElementById('adm-ano-ini')) fAno = document.getElementById('adm-ano-ini').value;
            
            let gAlunos=0, gAus=0, gAval=0, gLaudo=0;
            let gN1=0, gN2=0, gN3=0, gN4=0, gIni=0, gFlu=0;
            
            filteredAdmData = [];

            todosDadosAdm.forEach(d => {
                if (fEscola !== "TODAS" && d.escola !== fEscola) return;
                
                let dia = "", mes = "", ano = "";
                try {
                    if(d.data_avaliacao && d.data_avaliacao.includes('/')) { [dia, mes, ano] = d.data_avaliacao.split('/'); } 
                    else if(d.data_avaliacao && d.data_avaliacao.includes('-')) { [ano, mes, dia] = d.data_avaliacao.split('-'); }
                    if(mes) mes = mes.padStart(2, '0');
                } catch(e) {}

                if(fDia && dia !== fDia) return;
                if(fMes !== "TODOS" && mes !== fMes) return;
                if(fAno !== "TODOS" && ano !== fAno) return;

                let contribuiu = false; 
                let tAvalLocal = 0, tFluLocal = 0;
                let ruralSeriesMatched = new Set(); 

                if (d.serie === 'Multisseriada' || d.professor === 'Welma') {
                    if (d.detalhes && Array.isArray(d.detalhes)) {
                        d.detalhes.forEach(aluno => {
                            if(aluno.transferido) return;
                            
                            if (chkSeries.length > 0 && chkSeries.includes(aluno.serieRural)) {
                                gAlunos++;
                                if (aluno.nivel === 'Ausente') { gAus++; }
                                else if (aluno.nivel) {
                                    gAval++; tAvalLocal++;
                                    if (aluno.nivel === 'N√≠vel 1') gN1++;
                                    if (aluno.nivel === 'N√≠vel 2') gN2++;
                                    if (aluno.nivel === 'N√≠vel 3') gN3++;
                                    if (aluno.nivel === 'N√≠vel 4') gN4++;
                                    if (aluno.nivel === 'Iniciante') gIni++;
                                    if (aluno.nivel === 'Fluente') { gFlu++; tFluLocal++; }
                                }
                                if(aluno.laudo) gLaudo++;
                                contribuiu = true;
                                ruralSeriesMatched.add(aluno.serieRural); 
                            }
                        });
                    }
                } else {
                    if (chkSeries.length > 0 && chkSeries.includes(d.serie)) {
                        if(d.detalhes) {
                            d.detalhes.forEach(a => { 
                                if(a.transferido) return;
                                gAlunos++;
                                if (a.nivel === 'Ausente') { gAus++; }
                                else if (a.nivel) {
                                    gAval++; tAvalLocal++;
                                    if (a.nivel === 'N√≠vel 1') gN1++;
                                    if (a.nivel === 'N√≠vel 2') gN2++;
                                    if (a.nivel === 'N√≠vel 3') gN3++;
                                    if (a.nivel === 'N√≠vel 4') gN4++;
                                    if (a.nivel === 'Iniciante') gIni++;
                                    if (a.nivel === 'Fluente') { gFlu++; tFluLocal++; }
                                }
                                if (a.laudo) gLaudo++; 
                            });
                        }
                        contribuiu = true;
                    }
                }
                
                if (contribuiu) {
                    let pct = tAvalLocal > 0 ? (tFluLocal/tAvalLocal*100).toFixed(0)+"%" : "-";
                    let exibeSerie = d.serie;
                    
                    if ((d.serie === 'Multisseriada' || d.professor === 'Welma') && ruralSeriesMatched.size > 0 && ruralSeriesMatched.size < 5) {
                        let arrS = Array.from(ruralSeriesMatched).sort();
                        exibeSerie += `<br><small style="color:var(--primary); font-weight:bold;">(${arrS.join(', ')})</small>`;
                    }

                    filteredAdmData.push({
                        originalData: d,
                        exibeSerie: exibeSerie,
                        id: d.id,
                        escola: d.escola,
                        serieTurma: `${exibeSerie} ${d.turma}`,
                        data: d.data_avaliacao,
                        prof: d.professor,
                        pct: pct
                    });
                }
            });

            const pctN1 = gAval > 0 ? (gN1/gAval*100).toFixed(1) : 0;
            const pctN2 = gAval > 0 ? (gN2/gAval*100).toFixed(1) : 0;
            const pctN3 = gAval > 0 ? (gN3/gAval*100).toFixed(1) : 0;
            const pctN4 = gAval > 0 ? (gN4/gAval*100).toFixed(1) : 0;
            const pctIni = gAval > 0 ? (gIni/gAval*100).toFixed(1) : 0;
            const pctFlu = gAval > 0 ? (gFlu/gAval*100).toFixed(1) : 0;

            document.getElementById('adm-total').innerText = gAval;
            document.getElementById('adm-ausente').innerText = gAus;
            document.getElementById('adm-laudo').innerText = gLaudo;
            
            document.getElementById('adm-n1').innerText = pctN1 + "%";
            document.getElementById('adm-n2').innerText = pctN2 + "%";
            document.getElementById('adm-n3').innerText = pctN3 + "%";
            document.getElementById('adm-n4').innerText = pctN4 + "%";
            document.getElementById('adm-ini').innerText = pctIni + "%";
            document.getElementById('adm-flu').innerText = pctFlu + "%";

            currentPageAdm = 1;
            window.renderTableAdm();
            window.renderPaginationAdm();
        };

        window.renderTableAdm = () => {
            let html = "";
            const start = (currentPageAdm - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredAdmData.slice(start, end);

            if (pageData.length === 0) {
                html = "<tr><td colspan='6'>Sem dados.</td></tr>";
            } else {
                pageData.forEach(d => {
                    html += `<tr>
                        <td>${d.escola}</td><td>${d.serieTurma}</td><td>${d.data}</td><td>${d.prof}</td><td>${d.pct}</td>
                        <td><button class="btn-table" title="Inspecionar Avalia√ß√£o" onclick="window.abrirModalTurma('${d.id}', true)">üîç</button></td>
                    </tr>`;
                });
            }
            document.getElementById('tabela-envios').innerHTML = html;
        };

        window.mudarPaginaAdm = (page) => {
            currentPageAdm = page;
            window.renderTableAdm();
            window.renderPaginationAdm();
        };

        window.renderPaginationAdm = () => {
            const totalPages = Math.ceil(filteredAdmData.length / rowsPerPage);
            let html = "";
            if (totalPages > 1) {
                html += `<button class="page-btn" ${currentPageAdm === 1 ? 'disabled' : ''} onclick="window.mudarPaginaAdm(${currentPageAdm - 1})">¬´ Ant</button>`;
                
                let startPage = Math.max(1, currentPageAdm - 2);
                let endPage = Math.min(totalPages, currentPageAdm + 2);
                
                if (startPage > 1) html += `<span style="padding: 5px;">...</span>`;
                
                for(let i = startPage; i <= endPage; i++) {
                    html += `<button class="page-btn ${currentPageAdm === i ? 'active' : ''}" onclick="window.mudarPaginaAdm(${i})">${i}</button>`;
                }
                
                if (endPage < totalPages) html += `<span style="padding: 5px;">...</span>`;
                
                html += `<button class="page-btn" ${currentPageAdm === totalPages ? 'disabled' : ''} onclick="window.mudarPaginaAdm(${currentPageAdm + 1})">Pr√≥x ¬ª</button>`;
            }
            document.getElementById('paginacao-adm').innerHTML = html;
        };
    </script>
</body>
</html>
