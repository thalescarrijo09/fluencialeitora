<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAVEL - Sistema Integrado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --primary: #2E7D32; --secondary: #1565C0; --bg-light: #f4f4f9; --text: #333; --red: #d32f2f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-light); color: var(--text); margin:0; padding:10px; }
        
        .screen { display: none; max-width: 900px; margin: 0 auto; } /* Largura maior para ADM */
        .screen.active { display: block; }

        /* Login */
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; margin-top: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin-left: auto; margin-right: auto; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        /* Header */
        .app-header { background: var(--primary); color: white; padding: 15px; border-radius: 0 0 12px 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-logout { background: rgba(0,0,0,0.2); border: none; color: white; padding: 5px 12px; border-radius: 4px; cursor: pointer; }

        /* Componentes */
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* Alunos */
        .aluno-row { background: white; padding: 10px; margin-bottom: 5px; border-left: 5px solid #ccc; border-radius: 6px; }
        .aluno-row.avaliado { border-left-color: var(--primary); background: #e8f5e9; }
        .aluno-row.ausente { border-left-color: var(--red); background: #ffebee; }
        
        .controls { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
        select { padding: 8px; border-radius: 4px; flex: 1; border: 1px solid #ccc; }
        .laudo-chk { background: #eee; padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }
        
        /* Dashboard ADM */
        .dash-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: white; padding: 15px; text-align: center; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-num { font-size: 1.5rem; font-weight: bold; color: var(--secondary); }
        .adm-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .adm-table th, .adm-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        
        /* FILTROS ADM AVAN√áADOS */
        .filter-container { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .chk-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .chk-label { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; background: #eee; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .chk-label input { width: auto; margin: 0; }
        .chk-label:has(input:checked) { background: #c8e6c9; border: 1px solid var(--primary); }

        /* Utilit√°rios */
        .hidden { display: none; }
        .tag-laudo { color: var(--red); font-weight: bold; font-size: 0.75rem; display: none; }
        .aluno-row.com-laudo .tag-laudo { display: inline; }
        .no-print { }
        @media print { .no-print { display: none !important; } }
        @media (max-width: 600px) { .dash-grid { grid-template-columns: 1fr 1fr; } .filter-row { flex-direction: column; align-items: flex-start; } }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="login-box">
            <h1>üìö SIAVEL</h1>
            <p>Fa√ßa login para acessar</p>
            <input type="text" id="email" placeholder="E-mail (ex: jane@siavel.com)">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn-main" onclick="login()">ENTRAR</button>
            <p id="msg-login" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="screen-app" class="screen">
        <div class="app-header">
            <span id="header-user">Professor</span>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>

        <div id="area-config" class="card">
            <h3>Nova Avalia√ß√£o</h3>
            <label>Data:</label>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <select id="sel-dia"><option value="">Dia</option></select>
                <select id="sel-mes"><option value="01">Jan</option><option value="02">Fev</option><option value="03">Mar</option><option value="04">Abr</option><option value="05">Mai</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Ago</option><option value="09">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option></select>
                <select id="sel-ano"><option value="2026">2026</option></select>
            </div>
            <label>Escola:</label>
            <select id="sel-escola" style="width:100%; margin-bottom:10px;"></select>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>S√©rie:</label><select id="sel-serie" style="width:100%;"></select></div>
                <div style="flex:1;"><label>Turma:</label><select id="sel-turma" style="width:100%;"><option>A</option><option>B</option><option>C</option><option>D</option><option>Unica</option></select></div>
            </div>
            <label style="display:block; margin-top:10px;">Alunos (Cole a lista):</label>
            <textarea id="lista-alunos" style="width:100%; height:100px; border-radius:8px; border:1px solid #ccc;"></textarea>
            <button class="btn-main" onclick="iniciarAvaliacao()">COME√áAR</button>
        </div>

        <div id="area-avaliacao" class="hidden">
            <div class="action-bar no-print">
                <button class="btn-tool" style="background:#1565C0;" onclick="salvarNaNuvem()">‚òÅÔ∏è SALVAR</button>
                <button class="btn-tool" style="background:#D32F2F;" onclick="gerarPDF()">üìÑ PDF</button>
                <button class="btn-tool" style="background:#2E7D32;" onclick="compartilharZap()">üì± Zap</button>
            </div>
            <div class="card" style="border-left:5px solid var(--secondary);">
                <h3 id="resumo-titulo" style="margin:0;">Escola</h3>
                <p style="margin:5px 0; color:#666;"><span id="resumo-data">--</span> | <span id="resumo-sub">Turma</span></p>
                <div id="stats-rapido" style="font-weight:bold;">0 Avaliados</div>
            </div>
            <div id="container-alunos"></div>
            <div class="card no-print" style="background:#eee; text-align:center;">
                <input type="text" id="extra-nome" placeholder="Aluno extra..." style="width:70%;">
                <button onclick="addExtra()" style="width:20%; padding:10px;">+</button>
            </div>
            <button class="btn-main no-print" style="background:#666;" onclick="voltarConfig()">VOLTAR</button>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div class="app-header" style="background:#333;">
            <span>Painel Gestor</span>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>

        <div class="filter-container">
            <div style="margin-bottom:10px; font-weight:bold; color:#555;">Filtros:</div>
            <div class="filter-row">
                <select id="filtro-escola" onchange="aplicarFiltros()" style="max-width:200px;">
                    <option value="TODAS">Todas as Escolas</option>
                </select>
                
                <div class="chk-group" id="chk-series">
                    <label class="chk-label"><input type="checkbox" value="1¬∫ Ano" checked onchange="aplicarFiltros()"> 1¬∫ Ano</label>
                    <label class="chk-label"><input type="checkbox" value="2¬∫ Ano" checked onchange="aplicarFiltros()"> 2¬∫ Ano</label>
                    <label class="chk-label"><input type="checkbox" value="3¬∫ Ano" checked onchange="aplicarFiltros()"> 3¬∫ Ano</label>
                    <label class="chk-label"><input type="checkbox" value="4¬∫ Ano" checked onchange="aplicarFiltros()"> 4¬∫ Ano</label>
                    <label class="chk-label"><input type="checkbox" value="5¬∫ Ano" checked onchange="aplicarFiltros()"> 5¬∫ Ano</label>
                </div>
                
                <button onclick="carregarAdmin()" style="background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-left:auto;">üîÑ Atualizar</button>
            </div>
        </div>

        <div class="dash-grid">
            <div class="kpi-card"><div class="kpi-num" id="adm-total">0</div><div style="font-size:0.8rem;">Avaliados (Filtrado)</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-fluente" style="color:#2E7D32;">0%</div><div style="font-size:0.8rem;">Fluentes</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-critico" style="color:#d32f2f;">0%</div><div style="font-size:0.8rem;">N√≠veis Iniciais</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-ausente" style="color:#FBC02D;">0%</div><div style="font-size:0.8rem;">Aus√™ncia</div></div>
        </div>

        <div class="card">
            <h3>Registros</h3>
            <p style="font-size:0.8rem; color:#666;">*Se a escola for rural, os n√∫meros refletem apenas as s√©ries selecionadas.</p>
            <table class="adm-table">
                <thead><tr><th>Escola</th><th>Turma</th><th>Avaliados</th><th>Flu√™ncia</th></tr></thead>
                <tbody id="tabela-envios"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, push, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIGURA√á√ÉO
        const firebaseConfig = {
            apiKey: "AIzaSyCYV-OOz55TvJ7cLPfJkDP7idGL25MXxis",
            authDomain: "leituramineiros.firebaseapp.com",
            databaseURL: "https://leituramineiros-default-rtdb.firebaseio.com",
            projectId: "leituramineiros",
            storageBucket: "leituramineiros.firebasestorage.app",
            messagingSenderId: "221434879480",
            appId: "1:221434879480:web:1ca32bfc8ad743b5974a0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const PERFIS = {
            'jane@siavel.com': { nome: 'Jane', escolas: ['Paniago', 'Otal√©cio', 'Maria Eduarda', 'Salviano', 'Dom Bosco', 'Santo Ant√¥nio', 'Elias Carrijo', 'Tonico', 'Professor Juarez'], series: ['4¬∫ Ano', '5¬∫ Ano'], modo: 'padrao' },
            'wellita@siavel.com': { nome: 'Wellita', escolas: ['Paniago', 'Otal√©cio', 'Maria Eduarda', 'Salviano', 'Dom Bosco', 'Santo Ant√¥nio', 'Elias Carrijo', 'Tonico', 'Professor Juarez'], series: ['3¬∫ Ano'], modo: 'padrao' },
            'marcia@siavel.com': { nome: 'Marcia', escolas: ['Reverendo Eud√≥xio', 'Comecinho de Vida', 'Castelo Branco', 'Maria Eduarda', 'Padre Maximino', 'Dom Bosco', 'Professor Salviano Neves Amorim', 'Santo Ant√¥nio', 'Professor Juarez', 'Tonico Corredeira', 'Elias Carrijo de Souza', 'Paniago'], series: ['1¬∫ Ano', '2¬∫ Ano'], modo: 'padrao' },
            'welma@siavel.com': { nome: 'Welma', escolas: ['ESCOLA AM√âRICO CAETANO', 'ESCOLA FARROUPILHA', 'ESCOLA FARROUPILHA EXTENS√ÉO', 'ESCOLA ANTONIO ALVES', 'ESCOLA GUSTAVO ALVES', 'ESCOLA ANTONIO MESSIAS', 'ESCOLA CAIND√ÉO', 'ESCOLA SALTO', 'ESCOLA MORRO DOIS IRM√ÉOS', 'ESCOLA PINGUELA'], series: ['Multisseriada'], modo: 'rural' },
            'adm@siavel.com': { nome: 'Admin', modo: 'admin' }
        };

        const NIVEIS = ["N√≠vel 1", "N√≠vel 2", "N√≠vel 3", "N√≠vel 4", "Iniciante", "Fluente"];
        let usuarioAtual = null;
        let dadosTurma = {};
        let todosDadosAdm = []; 

        (function initDias() { const s = document.getElementById('sel-dia'); for(let i=1; i<=31; i++){ let o = document.createElement('option'); o.value = i < 10 ? "0"+i : i; o.innerText = i; s.appendChild(o); } })();

        window.login = () => {
            const e = document.getElementById('email').value;
            const s = document.getElementById('senha').value;
            signInWithEmailAndPassword(auth, e, s).catch(err => document.getElementById('msg-login').innerText = "Erro no Login.");
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (user) {
                const email = user.email;
                if (PERFIS[email]) {
                    usuarioAtual = { ...PERFIS[email], email: email };
                    if (usuarioAtual.modo === 'admin') {
                        document.getElementById('screen-admin').classList.add('active');
                        carregarAdmin();
                    } else {
                        document.getElementById('screen-app').classList.add('active');
                        configurarInterfaceProfessor();
                    }
                } else { alert("Usu√°rio n√£o configurado."); signOut(auth); }
            } else { document.getElementById('screen-login').classList.add('active'); }
        });

        function configurarInterfaceProfessor() {
            document.getElementById('header-user').innerText = `Ol√°, ${usuarioAtual.nome}`;
            const se = document.getElementById('sel-escola'); se.innerHTML = '<option value="">Selecione...</option>';
            usuarioAtual.escolas.forEach(esc => se.innerHTML += `<option>${esc}</option>`);
            const ss = document.getElementById('sel-serie'); ss.innerHTML = '';
            usuarioAtual.series.forEach(ser => ss.innerHTML += `<option>${ser}</option>`);
            document.getElementById('area-config').classList.remove('hidden');
            document.getElementById('area-avaliacao').classList.add('hidden');
        }

        window.iniciarAvaliacao = () => {
            const escola = document.getElementById('sel-escola').value;
            const lista = document.getElementById('lista-alunos').value.split('\n').filter(n=>n.trim()!=='');
            const d = document.getElementById('sel-dia').value;
            const m = document.getElementById('sel-mes').value;
            const a = document.getElementById('sel-ano').value;
            if(!d) return alert("Selecione o Dia!");
            if (!escola || lista.length === 0) return alert("Preencha dados!");

            dadosTurma = {
                escola: escola, serie: document.getElementById('sel-serie').value, turma: document.getElementById('sel-turma').value,
                data: `${d}/${m}/${a}`, alunos: lista.map(nome => ({ nome, nivel: '', laudo: false, serieRural: '' }))
            };
            renderizarAvaliacao();
            document.getElementById('area-config').classList.add('hidden');
            document.getElementById('area-avaliacao').classList.remove('hidden');
        };

        function renderizarAvaliacao() {
            document.getElementById('resumo-titulo').innerText = dadosTurma.escola;
            document.getElementById('resumo-data').innerText = dadosTurma.data;
            document.getElementById('resumo-sub').innerText = `${dadosTurma.serie} - Turma ${dadosTurma.turma}`;
            const container = document.getElementById('container-alunos'); container.innerHTML = '';
            dadosTurma.alunos.forEach((aluno, idx) => {
                const div = document.createElement('div'); div.className = 'aluno-row'; div.id = `row-${idx}`;
                let htmlSerie = '';
                if (usuarioAtual.modo === 'rural') {
                    htmlSerie = `<select class="sel-serie-rural" onchange="window.updateLocal(${idx}, this.value)"><option value="">S√©rie...</option>${["1¬∫ Ano","2¬∫ Ano","3¬∫ Ano","4¬∫ Ano","5¬∫ Ano"].map(s=>`<option ${aluno.serieRural===s?'selected':''}>${s}</option>`).join('')}</select>`;
                }
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;"><strong>${aluno.nome} <span class="tag-laudo">(LAUDO)</span></strong></div>
                    <div class="controls"><label class="laudo-chk"><input type="checkbox" onchange="window.toggleLaudo(${idx})" ${aluno.laudo?'checked':''}> Laudo</label>${htmlSerie}<select onchange="window.updateNivel(${idx}, this.value)"><option value="">Avaliar...</option><option value="Ausente">‚ö†Ô∏è Ausente</option>${NIVEIS.map(n=>`<option ${aluno.nivel===n?'selected':''}>${n}</option>`).join('')}</select></div>`;
                container.appendChild(div);
                if(aluno.laudo) div.classList.add('com-laudo');
            });
            atualizarStats();
        }

        window.toggleLaudo = (idx) => { dadosTurma.alunos[idx].laudo = !dadosTurma.alunos[idx].laudo; document.getElementById(`row-${idx}`).classList.toggle('com-laudo'); };
        window.updateNivel = (idx, val) => { dadosTurma.alunos[idx].nivel = val; const row = document.getElementById(`row-${idx}`); row.className = 'aluno-row ' + (dadosTurma.alunos[idx].laudo ? 'com-laudo' : ''); if (val === 'Ausente') row.classList.add('ausente'); else if (val) row.classList.add('avaliado'); atualizarStats(); };
        window.updateLocal = (idx, val) => { dadosTurma.alunos[idx].serieRural = val; };
        window.addExtra = () => { const nome = document.getElementById('extra-nome').value; if(nome) { dadosTurma.alunos.push({ nome, nivel: '', laudo: false, serieRural: '' }); renderizarAvaliacao(); document.getElementById('extra-nome').value = ''; } };
        window.voltarConfig = () => { if(confirm("Voltar sem salvar?")) { document.getElementById('area-avaliacao').classList.add('hidden'); document.getElementById('area-config').classList.remove('hidden'); } };
        function atualizarStats() { const aval = dadosTurma.alunos.filter(a => a.nivel && a.nivel !== 'Ausente').length; const aus = dadosTurma.alunos.filter(a => a.nivel === 'Ausente').length; document.getElementById('stats-rapido').innerText = `Status: ${aval} Avaliados | ${aus} Ausentes`; }

        window.salvarNaNuvem = async () => {
            const btn = document.querySelector('button[onclick="salvarNaNuvem()"]'); btn.innerText = "‚è≥ Enviando...";
            const cont = {}; NIVEIS.forEach(n => cont[n] = 0); let aval = 0, aus = 0;
            dadosTurma.alunos.forEach(a => { if (a.nivel === 'Ausente') aus++; else if (a.nivel) { aval++; cont[a.nivel]++; } });
            const pacote = { escola: dadosTurma.escola, turma: dadosTurma.turma, serie: dadosTurma.serie, professor: usuarioAtual.nome, data_avaliacao: dadosTurma.data, data_envio: new Date().toISOString(), total_alunos: dadosTurma.alunos.length, total_avaliados: aval, total_ausentes: aus, resultados: cont, detalhes: dadosTurma.alunos };
            try { await push(ref(db, 'avaliacoes'), pacote); alert("‚úÖ Sucesso!"); btn.innerText = "‚òÅÔ∏è SALVAR"; document.getElementById('lista-alunos').value = ""; document.getElementById('area-avaliacao').classList.add('hidden'); document.getElementById('area-config').classList.remove('hidden'); } catch (e) { console.error(e); alert("Erro: " + e.message); btn.innerText = "‚òÅÔ∏è Tentar Novamente"; }
        };
        window.gerarPDF = () => { const el = document.getElementById('area-avaliacao'); document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none'); html2pdf().from(el).save(`${dadosTurma.escola}.pdf`).then(() => { document.querySelectorAll('.no-print').forEach(e => e.style.display = ''); }); };
        window.compartilharZap = () => { let txt = `*${dadosTurma.escola}*\nData: ${dadosTurma.data}\nAv: ${dadosTurma.alunos.filter(a=>a.nivel&&a.nivel!='Ausente').length}\n\n`; dadosTurma.alunos.forEach(a => { if(a.nivel) txt += `${a.nivel==='Ausente'?'‚ö†Ô∏è':'‚úÖ'} ${a.nome}: ${a.nivel}\n`; }); window.open("https://wa.me/?text=" + encodeURIComponent(txt)); };

        // --- L√ìGICA DO ADMIN COM DEEP FILTER ---
        window.carregarAdmin = async () => {
            try {
                const dbRef = ref(db, 'avaliacoes');
                const snapshot = await get(dbRef);
                if (snapshot.exists()) {
                    todosDadosAdm = Object.values(snapshot.val());
                    todosDadosAdm.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));
                    
                    const escolasUnicas = [...new Set(todosDadosAdm.map(d => d.escola))].sort();
                    const selEscola = document.getElementById('filtro-escola');
                    selEscola.innerHTML = '<option value="TODAS">Todas as Escolas</option>';
                    escolasUnicas.forEach(esc => selEscola.innerHTML += `<option value="${esc}">${esc}</option>`);

                    aplicarFiltros();
                } else { document.getElementById('tabela-envios').innerHTML = "<tr><td colspan='4'>Nenhum dado encontrado.</td></tr>"; }
            } catch (error) { console.error(error); alert("Erro ao carregar dados."); }
        };

        window.aplicarFiltros = () => {
            const fEscola = document.getElementById('filtro-escola').value;
            const chkSeries = document.querySelectorAll('#chk-series input:checked');
            const seriesSelecionadas = Array.from(chkSeries).map(c => c.value);

            let gAlunos = 0, gFlu = 0, gCrit = 0, gAus = 0, gAval = 0;
            let htmlTabela = "";

            todosDadosAdm.forEach(d => {
                // 1. Filtro Escola
                if (fEscola !== "TODAS" && d.escola !== fEscola) return;

                // 2. Filtro S√©rie (L√≥gica H√≠brida)
                let contribuiu = false;
                let tAval = 0, tFlu = 0;

                // Caso RURAL: Verifica aluno por aluno
                if (d.serie === 'Multisseriada' || d.professor === 'Welma') {
                    if (d.detalhes && Array.isArray(d.detalhes)) {
                        d.detalhes.forEach(aluno => {
                            // Se a s√©rie do aluno est√° selecionada
                            if (seriesSelecionadas.includes(aluno.serieRural)) {
                                gAlunos++;
                                if (aluno.nivel === 'Ausente') { gAus++; }
                                else if (aluno.nivel) {
                                    gAval++; tAval++;
                                    if (aluno.nivel === 'Fluente') { gFlu++; tFlu++; }
                                    if (["N√≠vel 1","N√≠vel 2","N√≠vel 3","N√≠vel 4"].includes(aluno.nivel)) gCrit++;
                                }
                                contribuiu = true;
                            }
                        });
                    }
                } 
                // Caso URBANO: Verifica a s√©rie da turma inteira
                else {
                    if (seriesSelecionadas.includes(d.serie)) {
                        // Soma totais da turma
                        gAlunos += d.total_alunos;
                        gAus += d.total_ausentes;
                        gAval += d.total_avaliados;
                        
                        if(d.resultados) {
                            const flu = (d.resultados["Fluente"] || 0);
                            gFlu += flu; tFlu += flu; tAval += d.total_avaliados;
                            gCrit += ((d.resultados["N√≠vel 1"]||0) + (d.resultados["N√≠vel 2"]||0) + (d.resultados["N√≠vel 3"]||0) + (d.resultados["N√≠vel 4"]||0));
                        }
                        contribuiu = true;
                    }
                }

                if (contribuiu) {
                    let pct = tAval > 0 ? (tFlu/tAval*100).toFixed(0)+"%" : "-";
                    htmlTabela += `<tr><td>${d.escola}</td><td>${d.serie} ${d.turma}</td><td>${d.total_avaliados}</td><td>${pct}</td></tr>`;
                }
            });

            // Atualiza KPI
            document.getElementById('tabela-envios').innerHTML = htmlTabela || "<tr><td colspan='4'>Sem dados para este filtro.</td></tr>";
            document.getElementById('adm-total').innerText = gAval;
            document.getElementById('adm-fluente').innerText = gAval > 0 ? (gFlu/gAval*100).toFixed(1)+"%" : "0%";
            document.getElementById('adm-critico').innerText = gAval > 0 ? (gCrit/gAval*100).toFixed(1)+"%" : "0%";
            document.getElementById('adm-ausente').innerText = gAlunos > 0 ? (gAus/gAlunos*100).toFixed(1)+"%" : "0%";
        };
    </script>
</body>
</html>