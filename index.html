<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAVEL - Gest√£o Completa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --primary: #2E7D32; --secondary: #1565C0; --bg-light: #f4f4f9; --text: #333; --red: #d32f2f; --orange: #f57c00; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-light); color: var(--text); margin:0; padding:10px; }
        
        .screen { display: none; max-width: 950px; margin: 0 auto; }
        .screen.active { display: block; }

        /* Login */
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; margin-top: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin-left: auto; margin-right: auto; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        /* Header */
        .app-header { background: var(--primary); color: white; padding: 15px; border-radius: 0 0 12px 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-logout { background: rgba(0,0,0,0.2); border: none; color: white; padding: 5px 12px; border-radius: 4px; cursor: pointer; }

        /* ABAS */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e0e0e0; border-radius: 8px; font-weight: bold; cursor: pointer; color: #555; white-space: nowrap; min-width: 100px; }
        .tab-btn.active { background: var(--secondary); color: white; }

        /* Componentes */
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* Alunos e Tabelas */
        .aluno-row { background: white; padding: 10px; margin-bottom: 5px; border-left: 5px solid #ccc; border-radius: 6px; }
        .aluno-row.avaliado { border-left-color: var(--primary); background: #e8f5e9; }
        .aluno-row.ausente { border-left-color: var(--red); background: #ffebee; }
        
        .controls { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
        select { padding: 8px; border-radius: 4px; flex: 1; border: 1px solid #ccc; }
        .laudo-chk { background: #eee; padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }
        
        /* Tabela Comparativa */
        .comp-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .comp-table th { background: #f0f0f0; padding: 8px; text-align: left; color: #555; }
        .comp-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .badge-up { background: #e8f5e9; color: var(--primary); }
        .badge-down { background: #ffebee; color: var(--red); }
        .badge-same { background: #f5f5f5; color: #777; }
        
        /* Dashboard KPI */
        .dash-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: white; padding: 15px; text-align: center; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-num { font-size: 1.5rem; font-weight: bold; color: var(--secondary); }
        .adm-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .adm-table th, .adm-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        
        /* Filtros */
        .filter-container { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
        .chk-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .chk-label { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; background: #eee; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .chk-label input { width: auto; margin: 0; }
        .chk-label:has(input:checked) { background: #c8e6c9; border: 1px solid var(--primary); }
        .date-input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }

        /* Utilit√°rios */
        .hidden { display: none; }
        .tag-laudo { color: var(--red); font-weight: bold; font-size: 0.75rem; display: none; }
        .aluno-row.com-laudo .tag-laudo { display: inline; }
        .action-bar { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-tool { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; }
        
        @media print { .no-print { display: none !important; } }
        @media (max-width: 600px) { 
            .dash-grid { grid-template-columns: 1fr 1fr; } 
            .tabs { flex-wrap: wrap; } 
            .filter-row { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="login-box">
            <h1>üìö SIAVEL</h1>
            <p>Gest√£o & Evolu√ß√£o de Leitura</p>
            <input type="text" id="email" placeholder="E-mail">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn-main" onclick="login()">ENTRAR</button>
            <p id="msg-login" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="screen-app" class="screen">
        <div class="app-header">
            <span id="header-user">Professor</span>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>

        <div class="tabs no-print">
            <button class="tab-btn active" onclick="mudarAbaProf('nova')" id="tab-nova">üìù Nova</button>
            <button class="tab-btn" onclick="mudarAbaProf('hist')" id="tab-hist">üìä Meu Painel</button>
            <button class="tab-btn" onclick="mudarAbaProf('evo')" id="tab-evo">üìà Evolu√ß√£o</button>
        </div>

        <div id="view-nova">
            <div id="area-config" class="card">
                <h3>Configurar</h3>
                <label>Data:</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="sel-dia"><option value="">Dia</option></select>
                    <select id="sel-mes"><option value="01">Jan</option><option value="02">Fev</option><option value="03">Mar</option><option value="04">Abr</option><option value="05">Mai</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Ago</option><option value="09">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option></select>
                    <select id="sel-ano"><option value="2026">2026</option><option value="2025">2025</option></select>
                </div>
                <label>Escola:</label>
                <select id="sel-escola" style="width:100%; margin-bottom:10px;" onchange="verificarHistoricoTurma()"></select>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;"><label>S√©rie:</label><select id="sel-serie" style="width:100%;" onchange="verificarHistoricoTurma()"></select></div>
                    <div style="flex:1;"><label>Turma:</label><select id="sel-turma" style="width:100%;" onchange="verificarHistoricoTurma()"><option>A</option><option>B</option><option>C</option><option>D</option><option>Unica</option></select></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <label style="margin:0;">Alunos:</label>
                    <small id="msg-importacao" style="color:var(--primary); font-weight:bold; display:none;">üìã Lista carregada!</small>
                </div>
                <textarea id="lista-alunos" style="width:100%; height:100px; border-radius:8px; border:1px solid #ccc;"></textarea>
                <button class="btn-main" onclick="iniciarAvaliacao()">COME√áAR</button>
            </div>

            <div id="area-avaliacao" class="hidden">
                <div class="action-bar no-print">
                    <button class="btn-tool" style="background:#1565C0;" onclick="salvarNaNuvem()">‚òÅÔ∏è SALVAR</button>
                    <button class="btn-tool" style="background:#D32F2F;" onclick="gerarPDF()">üìÑ PDF</button>
                    <button class="btn-tool" style="background:#2E7D32;" onclick="compartilharZap()">üì± Zap</button>
                </div>
                <div class="card" style="border-left:5px solid var(--secondary);">
                    <h3 id="resumo-titulo" style="margin:0;">Escola</h3>
                    <p style="margin:5px 0; color:#666;"><span id="resumo-data">--</span> | <span id="resumo-sub">Turma</span></p>
                    <div id="stats-rapido" style="font-weight:bold;">0 Avaliados</div>
                </div>
                <div id="container-alunos"></div>
                <div class="card no-print" style="background:#eee; text-align:center;">
                    <input type="text" id="extra-nome" placeholder="Aluno extra..." style="width:70%;">
                    <button onclick="addExtra()" style="width:20%; padding:10px;">+</button>
                </div>
                <button class="btn-main no-print" style="background:#666;" onclick="voltarConfig()">VOLTAR</button>
            </div>
        </div>

        <div id="view-hist" class="hidden">
            <div class="filter-container">
                <div style="margin-bottom:5px; font-weight:bold; color:#555; font-size:0.9rem;">Filtrar meus dados:</div>
                <div class="filter-row">
                    <select id="prof-filtro-escola" onchange="aplicarFiltrosProf()">
                        <option value="TODAS">Todas as Escolas</option>
                    </select>
                    <select id="prof-filtro-serie" onchange="aplicarFiltrosProf()">
                        <option value="TODAS">Todas as S√©ries</option>
                        <option value="1¬∫ Ano">1¬∫ Ano</option>
                        <option value="2¬∫ Ano">2¬∫ Ano</option>
                        <option value="3¬∫ Ano">3¬∫ Ano</option>
                        <option value="4¬∫ Ano">4¬∫ Ano</option>
                        <option value="5¬∫ Ano">5¬∫ Ano</option>
                        <option value="Multisseriada">Multisseriada</option>
                    </select>
                    <select id="prof-filtro-turma" onchange="aplicarFiltrosProf()">
                        <option value="TODAS">Todas as Turmas</option>
                        <option value="A">Turma A</option>
                        <option value="B">Turma B</option>
                        <option value="C">Turma C</option>
                        <option value="D">Turma D</option>
                        <option value="Unica">√önica</option>
                    </select>
                </div>
                <div class="filter-row">
                    <span style="font-size:0.8rem;">De:</span><input type="date" id="prof-data-ini" class="date-input" onchange="aplicarFiltrosProf()">
                    <span style="font-size:0.8rem;">At√©:</span><input type="date" id="prof-data-fim" class="date-input" onchange="aplicarFiltrosProf()">
                </div>
            </div>

            <div class="dash-grid">
                <div class="kpi-card"><div class="kpi-num" id="prof-total">0</div><div style="font-size:0.8rem;">Avaliados (Filtro)</div></div>
                <div class="kpi-card"><div class="kpi-num" id="prof-fluente" style="color:#2E7D32;">0%</div><div style="font-size:0.8rem;">Fluentes</div></div>
                <div class="kpi-card"><div class="kpi-num" id="prof-critico" style="color:#d32f2f;">0%</div><div style="font-size:0.8rem;">N√≠veis Iniciais</div></div>
                <div class="kpi-card"><div class="kpi-num" id="prof-ausente" style="color:#FBC02D;">0%</div><div style="font-size:0.8rem;">Aus√™ncia</div></div>
            </div>
            <div class="card">
                <h3>Minhas Turmas</h3>
                <button onclick="carregarHistoricoProf()" style="float:right; font-size:0.7rem;">Atualizar</button>
                <table class="adm-table">
                    <thead><tr><th>Escola</th><th>Turma</th><th>Data</th><th>Status</th></tr></thead>
                    <tbody id="tabela-prof"></tbody>
                </table>
            </div>
        </div>

        <div id="view-evo" class="hidden">
            <div class="card">
                <h3>üîç Comparar Turma</h3>
                <label>Selecione a Turma para Analisar:</label>
                <select id="filtro-evo-turma" style="width:100%; margin-bottom:10px;">
                    <option value="">Carregando turmas...</option>
                </select>
                <button class="btn-main" onclick="gerarRelatorioEvolucao()" style="padding:10px;">GERAR COMPARATIVO</button>
            </div>

            <div id="resultado-evo" class="hidden">
                <div class="card">
                    <h4>Resultado Comparativo</h4>
                    <p id="evo-info" style="font-size:0.9rem; color:#666;">Comparando √∫ltima avalia√ß√£o com a anterior.</p>
                    <table class="comp-table">
                        <thead><tr><th>Aluno</th><th>Antes</th><th>Agora</th><th>Evolu√ß√£o</th></tr></thead>
                        <tbody id="tabela-evo"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div class="app-header" style="background:#333;">
            <span>Painel Gestor</span>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>

        <div class="filter-container">
            <div style="margin-bottom:10px; font-weight:bold; color:#555;">Filtros:</div>
            <div class="filter-row">
                <select id="filtro-escola" onchange="aplicarFiltros()" style="max-width:200px;">
                    <option value="TODAS">Todas as Escolas</option>
                </select>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="font-size:0.8rem;">De:</span><input type="date" id="filtro-data-ini" class="date-input" onchange="aplicarFiltros()">
                    <span style="font-size:0.8rem;">At√©:</span><input type="date" id="filtro-data-fim" class="date-input" onchange="aplicarFiltros()">
                </div>
            </div>
            <div class="filter-row">
                <div class="chk-group" id="chk-series">
                    <label class="chk-label"><input type="checkbox" value="1¬∫ Ano" checked onchange="aplicarFiltros()"> 1¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="2¬∫ Ano" checked onchange="aplicarFiltros()"> 2¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="3¬∫ Ano" checked onchange="aplicarFiltros()"> 3¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="4¬∫ Ano" checked onchange="aplicarFiltros()"> 4¬∫</label>
                    <label class="chk-label"><input type="checkbox" value="5¬∫ Ano" checked onchange="aplicarFiltros()"> 5¬∫</label>
                </div>
                <button onclick="carregarAdmin()" style="background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-left:auto;">üîÑ Atualizar</button>
            </div>
        </div>

        <div class="dash-grid">
            <div class="kpi-card"><div class="kpi-num" id="adm-total">0</div><div style="font-size:0.8rem;">Avaliados</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-fluente" style="color:#2E7D32;">0%</div><div style="font-size:0.8rem;">Fluentes</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-critico" style="color:#d32f2f;">0%</div><div style="font-size:0.8rem;">N√≠veis Iniciais</div></div>
            <div class="kpi-card"><div class="kpi-num" id="adm-ausente" style="color:#FBC02D;">0%</div><div style="font-size:0.8rem;">Aus√™ncia</div></div>
        </div>

        <div class="card">
            <h3>Registros</h3>
            <table class="adm-table">
                <thead><tr><th>Escola</th><th>Turma</th><th>Data</th><th>Prof.</th><th>Flu√™ncia</th></tr></thead>
                <tbody id="tabela-envios"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYV-OOz55TvJ7cLPfJkDP7idGL25MXxis",
            authDomain: "leituramineiros.firebaseapp.com",
            databaseURL: "https://leituramineiros-default-rtdb.firebaseio.com",
            projectId: "leituramineiros",
            storageBucket: "leituramineiros.firebasestorage.app",
            messagingSenderId: "221434879480",
            appId: "1:221434879480:web:1ca32bfc8ad743b5974a0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const PERFIS = {
            'jane@siavel.com': { nome: 'Jane', escolas: ['Paniago', 'Otal√©cio', 'Maria Eduarda', 'Salviano', 'Dom Bosco', 'Santo Ant√¥nio', 'Elias Carrijo', 'Tonico', 'Professor Juarez'], series: ['4¬∫ Ano', '5¬∫ Ano'], modo: 'padrao' },
            'wellita@siavel.com': { nome: 'Wellita', escolas: ['Paniago', 'Otal√©cio', 'Maria Eduarda', 'Salviano', 'Dom Bosco', 'Santo Ant√¥nio', 'Elias Carrijo', 'Tonico', 'Professor Juarez'], series: ['3¬∫ Ano'], modo: 'padrao' },
            'marcia@siavel.com': { nome: 'Marcia', escolas: ['Reverendo Eud√≥xio', 'Comecinho de Vida', 'Castelo Branco', 'Maria Eduarda', 'Padre Maximino', 'Dom Bosco', 'Professor Salviano Neves Amorim', 'Santo Ant√¥nio', 'Professor Juarez', 'Tonico Corredeira', 'Elias Carrijo de Souza', 'Paniago'], series: ['1¬∫ Ano', '2¬∫ Ano'], modo: 'padrao' },
            'welma@siavel.com': { nome: 'Welma', escolas: ['ESCOLA AM√âRICO CAETANO', 'ESCOLA FARROUPILHA', 'ESCOLA FARROUPILHA EXTENS√ÉO', 'ESCOLA ANTONIO ALVES', 'ESCOLA GUSTAVO ALVES', 'ESCOLA ANTONIO MESSIAS', 'ESCOLA CAIND√ÉO', 'ESCOLA SALTO', 'ESCOLA MORRO DOIS IRM√ÉOS', 'ESCOLA PINGUELA'], series: ['Multisseriada'], modo: 'rural' },
            'adm@siavel.com': { nome: 'Admin', modo: 'admin' }
        };

        const NIVEIS = ["N√≠vel 1", "N√≠vel 2", "N√≠vel 3", "N√≠vel 4", "Iniciante", "Fluente"];
        const PESO_NIVEL = { "Ausente": 0, "N√≠vel 1": 1, "N√≠vel 2": 2, "N√≠vel 3": 3, "N√≠vel 4": 4, "Iniciante": 5, "Fluente": 6 };
        
        let usuarioAtual = null;
        let dadosTurma = {};
        let meusEnviosCache = [];
        let todosDadosAdm = []; 

        (function initDias() { const s = document.getElementById('sel-dia'); for(let i=1; i<=31; i++){ let o = document.createElement('option'); o.value = i < 10 ? "0"+i : i; o.innerText = i; s.appendChild(o); } })();

        window.login = () => {
            const e = document.getElementById('email').value;
            const s = document.getElementById('senha').value;
            signInWithEmailAndPassword(auth, e, s).catch(err => document.getElementById('msg-login').innerText = "Erro no Login.");
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (user) {
                const email = user.email;
                if (PERFIS[email]) {
                    usuarioAtual = { ...PERFIS[email], email: email };
                    if (usuarioAtual.modo === 'admin') {
                        document.getElementById('screen-admin').classList.add('active');
                        carregarAdmin();
                    } else {
                        document.getElementById('screen-app').classList.add('active');
                        configurarInterfaceProfessor();
                        carregarHistoricoProf();
                    }
                } else { alert("Usu√°rio n√£o configurado."); signOut(auth); }
            } else { document.getElementById('screen-login').classList.add('active'); }
        });

        window.mudarAbaProf = (aba) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            ['view-nova','view-hist','view-evo'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            if(aba === 'nova') {
                document.getElementById('tab-nova').classList.add('active');
                document.getElementById('view-nova').classList.remove('hidden');
            } else if(aba === 'hist') {
                document.getElementById('tab-hist').classList.add('active');
                document.getElementById('view-hist').classList.remove('hidden');
                carregarHistoricoProf();
            } else if(aba === 'evo') {
                document.getElementById('tab-evo').classList.add('active');
                document.getElementById('view-evo').classList.remove('hidden');
                prepararComparativo();
            }
        };

        function configurarInterfaceProfessor() {
            document.getElementById('header-user').innerText = `Ol√°, ${usuarioAtual.nome}`;
            const se = document.getElementById('sel-escola'); se.innerHTML = '<option value="">Selecione...</option>';
            usuarioAtual.escolas.forEach(esc => se.innerHTML += `<option>${esc}</option>`);
            const ss = document.getElementById('sel-serie'); ss.innerHTML = '';
            usuarioAtual.series.forEach(ser => ss.innerHTML += `<option>${ser}</option>`);
            mudarAbaProf('nova');
        }

        window.verificarHistoricoTurma = async () => {
            const esc = document.getElementById('sel-escola').value;
            const ser = document.getElementById('sel-serie').value;
            const tur = document.getElementById('sel-turma').value;
            const msg = document.getElementById('msg-importacao');
            msg.style.display = 'none';

            if(esc && ser && tur) {
                const dbRef = ref(db, 'avaliacoes');
                const snapshot = await get(dbRef);
                if (snapshot.exists()) {
                    const all = Object.values(snapshot.val());
                    const matches = all.filter(d => d.escola === esc && d.serie === ser && d.turma === tur);
                    
                    if (matches.length > 0) {
                        matches.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));
                        const ultima = matches[0];
                        if (ultima.detalhes && Array.isArray(ultima.detalhes)) {
                            const nomes = ultima.detalhes.map(a => a.nome).join('\n');
                            document.getElementById('lista-alunos').value = nomes;
                            msg.innerText = `üìã Lista importada de ${ultima.data_avaliacao}`;
                            msg.style.display = 'block';
                        }
                    }
                }
            }
        };

        window.iniciarAvaliacao = () => {
            const escola = document.getElementById('sel-escola').value;
            const lista = document.getElementById('lista-alunos').value.split('\n').filter(n=>n.trim()!=='');
            const d = document.getElementById('sel-dia').value;
            const m = document.getElementById('sel-mes').value;
            const a = document.getElementById('sel-ano').value;
            if(!d) return alert("Selecione o Dia!");
            if (!escola || lista.length === 0) return alert("Preencha dados!");

            dadosTurma = {
                escola: escola, serie: document.getElementById('sel-serie').value, turma: document.getElementById('sel-turma').value,
                data: `${d}/${m}/${a}`, alunos: lista.map(nome => ({ nome, nivel: '', laudo: false, serieRural: '' }))
            };
            renderizarAvaliacao();
            document.getElementById('area-config').classList.add('hidden');
            document.getElementById('area-avaliacao').classList.remove('hidden');
        };

        function renderizarAvaliacao() {
            document.getElementById('resumo-titulo').innerText = dadosTurma.escola;
            document.getElementById('resumo-data').innerText = dadosTurma.data;
            document.getElementById('resumo-sub').innerText = `${dadosTurma.serie} - Turma ${dadosTurma.turma}`;
            const container = document.getElementById('container-alunos'); container.innerHTML = '';
            dadosTurma.alunos.forEach((aluno, idx) => {
                const div = document.createElement('div'); div.className = 'aluno-row'; div.id = `row-${idx}`;
                let htmlSerie = '';
                if (usuarioAtual.modo === 'rural') {
                    htmlSerie = `<select class="sel-serie-rural" onchange="window.updateLocal(${idx}, this.value)"><option value="">S√©rie...</option>${["1¬∫ Ano","2¬∫ Ano","3¬∫ Ano","4¬∫ Ano","5¬∫ Ano"].map(s=>`<option ${aluno.serieRural===s?'selected':''}>${s}</option>`).join('')}</select>`;
                }
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;"><strong>${aluno.nome} <span class="tag-laudo">(LAUDO)</span></strong></div>
                    <div class="controls"><label class="laudo-chk"><input type="checkbox" onchange="window.toggleLaudo(${idx})" ${aluno.laudo?'checked':''}> Laudo</label>${htmlSerie}<select onchange="window.updateNivel(${idx}, this.value)"><option value="">Avaliar...</option><option value="Ausente">‚ö†Ô∏è Ausente</option>${NIVEIS.map(n=>`<option ${aluno.nivel===n?'selected':''}>${n}</option>`).join('')}</select></div>`;
                container.appendChild(div);
                if(aluno.laudo) div.classList.add('com-laudo');
            });
            atualizarStats();
        }

        window.toggleLaudo = (idx) => { dadosTurma.alunos[idx].laudo = !dadosTurma.alunos[idx].laudo; document.getElementById(`row-${idx}`).classList.toggle('com-laudo'); };
        window.updateNivel = (idx, val) => { dadosTurma.alunos[idx].nivel = val; const row = document.getElementById(`row-${idx}`); row.className = 'aluno-row ' + (dadosTurma.alunos[idx].laudo ? 'com-laudo' : ''); if (val === 'Ausente') row.classList.add('ausente'); else if (val) row.classList.add('avaliado'); atualizarStats(); };
        window.updateLocal = (idx, val) => { dadosTurma.alunos[idx].serieRural = val; };
        window.addExtra = () => { const nome = document.getElementById('extra-nome').value; if(nome) { dadosTurma.alunos.push({ nome, nivel: '', laudo: false, serieRural: '' }); renderizarAvaliacao(); document.getElementById('extra-nome').value = ''; } };
        window.voltarConfig = () => { if(confirm("Voltar sem salvar?")) { document.getElementById('area-avaliacao').classList.add('hidden'); document.getElementById('area-config').classList.remove('hidden'); } };
        function atualizarStats() { const aval = dadosTurma.alunos.filter(a => a.nivel && a.nivel !== 'Ausente').length; const aus = dadosTurma.alunos.filter(a => a.nivel === 'Ausente').length; document.getElementById('stats-rapido').innerText = `Status: ${aval} Avaliados | ${aus} Ausentes`; }

        window.salvarNaNuvem = async () => {
            const btn = document.querySelector('button[onclick="salvarNaNuvem()"]'); btn.innerText = "‚è≥ Enviando...";
            const cont = {}; NIVEIS.forEach(n => cont[n] = 0); let aval = 0, aus = 0;
            dadosTurma.alunos.forEach(a => { if (a.nivel === 'Ausente') aus++; else if (a.nivel) { aval++; cont[a.nivel]++; } });
            const pacote = { escola: dadosTurma.escola, turma: dadosTurma.turma, serie: dadosTurma.serie, professor: usuarioAtual.nome, data_avaliacao: dadosTurma.data, data_envio: new Date().toISOString(), total_alunos: dadosTurma.alunos.length, total_avaliados: aval, total_ausentes: aus, resultados: cont, detalhes: dadosTurma.alunos };
            try { await push(ref(db, 'avaliacoes'), pacote); alert("‚úÖ Sucesso!"); btn.innerText = "‚òÅÔ∏è SALVAR"; document.getElementById('lista-alunos').value = ""; document.getElementById('area-avaliacao').classList.add('hidden'); document.getElementById('area-config').classList.remove('hidden'); } catch (e) { console.error(e); alert("Erro: " + e.message); btn.innerText = "‚òÅÔ∏è Tentar Novamente"; }
        };
        window.gerarPDF = () => { const el = document.getElementById('area-avaliacao'); document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none'); html2pdf().from(el).save(`${dadosTurma.escola}.pdf`).then(() => { document.querySelectorAll('.no-print').forEach(e => e.style.display = ''); }); };
        window.compartilharZap = () => { let txt = `*${dadosTurma.escola}*\nData: ${dadosTurma.data}\nAv: ${dadosTurma.alunos.filter(a=>a.nivel&&a.nivel!='Ausente').length}\n\n`; dadosTurma.alunos.forEach(a => { if(a.nivel) txt += `${a.nivel==='Ausente'?'‚ö†Ô∏è':'‚úÖ'} ${a.nome}: ${a.nivel}\n`; }); window.open("https://wa.me/?text=" + encodeURIComponent(txt)); };

        // --- DASHBOARD PROFESSOR COM FILTROS (NOVO) ---
        window.carregarHistoricoProf = async () => {
            const dbRef = ref(db, 'avaliacoes');
            const snapshot = await get(dbRef);
            meusEnviosCache = [];

            if (snapshot.exists()) {
                const all = Object.values(snapshot.val());
                meusEnviosCache = all.filter(d => d.professor === usuarioAtual.nome);
                meusEnviosCache.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));

                // Popula Filtro de Escolas do Prof
                const escolasProf = [...new Set(meusEnviosCache.map(d => d.escola))].sort();
                const sel = document.getElementById('prof-filtro-escola');
                sel.innerHTML = '<option value="TODAS">Todas as Escolas</option>';
                escolasProf.forEach(e => sel.innerHTML += `<option value="${e}">${e}</option>`);

                aplicarFiltrosProf();
            } else {
                aplicarFiltrosProf(); // Renderiza vazio
            }
        };

        window.aplicarFiltrosProf = () => {
            const fEsc = document.getElementById('prof-filtro-escola').value;
            const fSer = document.getElementById('prof-filtro-serie').value;
            const fTur = document.getElementById('prof-filtro-turma').value;
            const fIni = document.getElementById('prof-data-ini').value;
            const fFim = document.getElementById('prof-data-fim').value;

            let tAlunos=0, tFlu=0, tCrit=0, tAus=0, tAval=0;
            let html = "";

            meusEnviosCache.forEach(d => {
                // Checa filtros
                if (fEsc !== "TODAS" && d.escola !== fEsc) return;
                if (fSer !== "TODAS" && d.serie !== fSer) return;
                if (fTur !== "TODAS" && d.turma !== fTur) return;
                
                if (fIni || fFim) {
                    const dataAval = parseDataBR(d.data_avaliacao);
                    if (fIni && dataAval < new Date(fIni)) return;
                    if (fFim && dataAval > new Date(fFim)) return;
                }

                // Soma Estat√≠sticas
                tAlunos += d.total_alunos; tAval += d.total_avaliados; tAus += d.total_ausentes;
                if(d.resultados) {
                    tFlu += (d.resultados["Fluente"] || 0);
                    tCrit += ((d.resultados["N√≠vel 1"]||0) + (d.resultados["N√≠vel 2"]||0) + (d.resultados["N√≠vel 3"]||0) + (d.resultados["N√≠vel 4"]||0));
                }

                html += `<tr><td>${d.escola}</td><td>${d.serie} ${d.turma}</td><td>${d.data_avaliacao}</td><td style="color:green;">‚úÖ Enviado</td></tr>`;
            });

            document.getElementById('tabela-prof').innerHTML = html || "<tr><td colspan='4'>Nenhum dado encontrado com este filtro.</td></tr>";
            
            // Atualiza KPI
            document.getElementById('prof-total').innerText = tAval;
            document.getElementById('prof-fluente').innerText = tAval > 0 ? (tFlu/tAval*100).toFixed(1)+"%" : "0%";
            document.getElementById('prof-critico').innerText = tAval > 0 ? (tCrit/tAval*100).toFixed(1)+"%" : "0%";
            document.getElementById('prof-ausente').innerText = tAlunos > 0 ? (tAus/tAlunos*100).toFixed(1)+"%" : "0%";
        };

        // ... Resto do c√≥digo (Evolu√ß√£o, Admin) mant√©m igual ...
        
        window.prepararComparativo = () => {
            const select = document.getElementById('filtro-evo-turma');
            select.innerHTML = '<option value="">Selecione...</option>';
            const chavesUnicas = new Set();
            meusEnviosCache.forEach(d => { chavesUnicas.add(`${d.escola}|${d.serie}|${d.turma}`); });
            chavesUnicas.forEach(key => { const [esc, ser, tur] = key.split('|'); const opt = document.createElement('option'); opt.value = key; opt.innerText = `${esc} - ${ser} ${tur}`; select.appendChild(opt); });
        };

        window.gerarRelatorioEvolucao = () => {
            const key = document.getElementById('filtro-evo-turma').value;
            if(!key) return alert("Selecione uma turma.");
            const [esc, ser, tur] = key.split('|');
            const avaliacoesTurma = meusEnviosCache.filter(d => d.escola === esc && d.serie === ser && d.turma === tur);
            avaliacoesTurma.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));

            if(avaliacoesTurma.length < 2) {
                document.getElementById('tabela-evo').innerHTML = "<tr><td colspan='4'>Precisa de pelo menos 2 avalia√ß√µes.</td></tr>";
                document.getElementById('resultado-evo').classList.remove('hidden'); return;
            }
            const atual = avaliacoesTurma[0]; const anterior = avaliacoesTurma[1];
            document.getElementById('evo-info').innerText = `Comparando: ${atual.data_avaliacao} vs ${anterior.data_avaliacao}`;

            let html = "";
            if(atual.detalhes) {
                atual.detalhes.forEach(alunoAtual => {
                    const alunoAnt = anterior.detalhes ? anterior.detalhes.find(a => a.nome.toLowerCase().trim() === alunoAtual.nome.toLowerCase().trim()) : null;
                    const nivelAtual = alunoAtual.nivel || "-";
                    const nivelAnt = alunoAnt ? (alunoAnt.nivel || "-") : "Novo";
                    let badge = '<span class="badge badge-same">‚ûñ Manteve</span>';
                    if (alunoAnt && PESO_NIVEL[nivelAtual] !== undefined && PESO_NIVEL[nivelAnt] !== undefined) {
                        if (PESO_NIVEL[nivelAtual] > PESO_NIVEL[nivelAnt]) badge = '<span class="badge badge-up">‚¨ÜÔ∏è Evoluiu</span>';
                        else if (PESO_NIVEL[nivelAtual] < PESO_NIVEL[nivelAnt]) badge = '<span class="badge badge-down">‚¨áÔ∏è Regrediu</span>';
                    } else if (nivelAnt === "Novo") { badge = '<span class="badge" style="background:#e3f2fd; color:#1565C0;">üÜï Novo</span>'; }
                    html += `<tr><td>${alunoAtual.nome}</td><td>${nivelAnt}</td><td><strong>${nivelAtual}</strong></td><td>${badge}</td></tr>`;
                });
            }
            document.getElementById('tabela-evo').innerHTML = html;
            document.getElementById('resultado-evo').classList.remove('hidden');
        };

        window.carregarAdmin = async () => {
            const dbRef = ref(db, 'avaliacoes');
            const snapshot = await get(dbRef);
            if (snapshot.exists()) {
                todosDadosAdm = Object.values(snapshot.val());
                todosDadosAdm.sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));
                const escolasUnicas = [...new Set(todosDadosAdm.map(d => d.escola))].sort();
                const selEscola = document.getElementById('filtro-escola');
                selEscola.innerHTML = '<option value="TODAS">Todas as Escolas</option>';
                escolasUnicas.forEach(esc => selEscola.innerHTML += `<option value="${esc}">${esc}</option>`);
                aplicarFiltros();
            } else { document.getElementById('tabela-envios').innerHTML = "<tr><td colspan='5'>Nenhum dado.</td></tr>"; }
        };

        function parseDataBR(strData) { const p = strData.split('/'); return new Date(p[2], p[1]-1, p[0]); }

        window.aplicarFiltros = () => {
            const fEscola = document.getElementById('filtro-escola').value;
            const chkSeries = Array.from(document.querySelectorAll('#chk-series input:checked')).map(c => c.value);
            const fDataIni = document.getElementById('filtro-data-ini').value;
            const fDataFim = document.getElementById('filtro-data-fim').value;
            
            let gAlunos=0, gFlu=0, gCrit=0, gAus=0, gAval=0;
            let htmlTabela = "";

            todosDadosAdm.forEach(d => {
                if (fEscola !== "TODAS" && d.escola !== fEscola) return;
                if (fDataIni || fDataFim) {
                    const dataAval = parseDataBR(d.data_avaliacao);
                    if (fDataIni && dataAval < new Date(fDataIni)) return;
                    if (fDataFim && dataAval > new Date(fDataFim)) return;
                }

                let contribuiu = false;
                let tAval = 0, tFlu = 0;

                if (d.serie === 'Multisseriada' || d.professor === 'Welma') {
                    if (d.detalhes && Array.isArray(d.detalhes)) {
                        d.detalhes.forEach(aluno => {
                            if (chkSeries.includes(aluno.serieRural)) {
                                gAlunos++;
                                if (aluno.nivel === 'Ausente') { gAus++; }
                                else if (aluno.nivel) {
                                    gAval++; tAval++;
                                    if (aluno.nivel === 'Fluente') { gFlu++; tFlu++; }
                                    if (["N√≠vel 1","N√≠vel 2","N√≠vel 3","N√≠vel 4"].includes(aluno.nivel)) gCrit++;
                                }
                                contribuiu = true;
                            }
                        });
                    }
                } else {
                    if (chkSeries.includes(d.serie)) {
                        gAlunos += d.total_alunos; gAus += d.total_ausentes; gAval += d.total_avaliados;
                        if(d.resultados) {
                            const flu = (d.resultados["Fluente"] || 0);
                            gFlu += flu; tFlu += flu; tAval += d.total_avaliados;
                            gCrit += ((d.resultados["N√≠vel 1"]||0) + (d.resultados["N√≠vel 2"]||0) + (d.resultados["N√≠vel 3"]||0) + (d.resultados["N√≠vel 4"]||0));
                        }
                        contribuiu = true;
                    }
                }

                if (contribuiu) {
                    let pct = tAval > 0 ? (tFlu/tAval*100).toFixed(0)+"%" : "-";
                    htmlTabela += `<tr><td>${d.escola}</td><td>${d.serie} ${d.turma}</td><td>${d.data_avaliacao}</td><td>${d.professor}</td><td>${pct}</td></tr>`;
                }
            });

            document.getElementById('tabela-envios').innerHTML = htmlTabela || "<tr><td colspan='5'>Sem dados.</td></tr>";
            document.getElementById('adm-total').innerText = gAval;
            document.getElementById('adm-fluente').innerText = gAval > 0 ? (gFlu/gAval*100).toFixed(1)+"%" : "0%";
            document.getElementById('adm-critico').innerText = gAval > 0 ? (gCrit/gAval*100).toFixed(1)+"%" : "0%";
            document.getElementById('adm-ausente').innerText = gAlunos > 0 ? (gAus/gAlunos*100).toFixed(1)+"%" : "0%";
        };
    </script>
</body>
</html>
